<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Math Champs - Placement Test (Test Mode)</title>
    <!-- Font 'Nunito' & 'Noto Sans' -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">
    <!-- KaTeX untuk Rumus Matematika Cantik -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        :root {
            --primary: #FF9F1C;
            --primary-dark: #e08b15;
            --secondary: #2EC4B6;
            --secondary-dark: #259f93;
            --accent: #E71D36;
            --dark: #011627;
            --light: #FDFFFC;
            --bg-gradient: linear-gradient(135deg, #E0F7FA 0%, #80DEEA 100%);
            --header-bg: #011627;
            --text-main: #2c3e50;
            /* Singapore Math Palette */
            --mainblue: #006EBE;
            --softblue: #EBF5FF;
            --maingreen: #28B464;
            --softgreen: #EBFAF0;
            --mainred: #DC3C32;
            --softred: #FFF0F0;
            --honeyyellow: #FFC832;
            --honeysoft: #FFF5D2;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- GLOBAL LAYOUT --- */
        html { height: 100%; }

        body {
            font-family: 'Nunito', sans-serif;
            background: var(--bg-gradient);
            margin: 0;
            padding: 0;
            color: var(--text-main);
            height: 100%;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            width: 100vw;
            background-image:
                radial-gradient(#2EC4B6 1px, transparent 1px),
                radial-gradient(#2EC4B6 1px, transparent 1px);
            background-position: 0 0, 25px 25px;
            background-size: 50px 50px;
            background-color: #f0f8ff;
        }

        /* --- HEADER --- */
        header {
            background: var(--header-bg);
            padding: 15px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 50;
            position: relative;
            flex-shrink: 0;
            height: 80px;
        }

        .logo {
            height: 40px;
            object-fit: contain;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
            display: block;
        }

        .status-bar {
            display: flex;
            gap: 15px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.15);
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: 800;
            color: white;
            font-size: 1.2rem;
            border: 2px solid rgba(255,255,255,0.2);
        }

        /* --- DESKTOP LAYOUT (IMMERSIVE) --- */
        @media (min-width: 769px) {
            body { overflow: hidden; }
            .app-container { height: 100vh; }
            .game-stage {
                flex: 1;
                overflow-y: auto;
                padding: 20px;
                display: flex;
                justify-content: center;
                scrollbar-width: thin;
            }
            .content-card {
                margin: auto 0;
                max-width: 900px;
                background: rgba(255, 255, 255, 0.95);
                border-radius: 24px;
                padding: 40px;
                box-shadow: 0 10px 40px rgba(1, 22, 39, 0.1);
                animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                width: 100%;
            }
            .feedback-container {
                margin-top: 30px;
                display: none;
                flex-direction: column;
                align-items: center;
                animation: popIn 0.3s ease;
            }
        }

        /* --- MOBILE LAYOUT (SCROLL FIX) --- */
        @media (max-width: 768px) {
            body { overflow-y: auto; height: auto; }
            html { height: auto; }
            .app-container { height: auto; min-height: 100vh; background-size: 20px 20px; }
            header { position: sticky; top: 0; padding: 12px 20px; justify-content: space-between; }
            .game-stage { display: block; height: auto; padding: 0; overflow: visible; }
            .content-card {
                background: white;
                max-width: none;
                border-radius: 0;
                box-shadow: none;
                margin: 0;
                min-height: calc(100vh - 80px);
                padding: 25px 20px 150px 20px;
            }
            h1 { font-size: 1.6rem !important; }
            .question-box { font-size: 1.1rem !important; }
            .feedback-container {
                position: fixed; bottom: 0; left: 0; right: 0;
                background: white; padding: 20px;
                box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
                animation: slideUp 0.3s ease;
                border-top: 1px solid #eee;
                display: none;
                flex-direction: column; align-items: center;
                z-index: 100;
            }
        }

        /* --- ANIMATIONS & COMMON --- */
        @keyframes popIn {
            from { opacity: 0; transform: scale(0.95) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        h1 {
            color: var(--primary); font-weight: 900; font-size: 2.2rem;
            margin: 0 0 10px 0; text-transform: uppercase; letter-spacing: -0.5px;
        }

        h2 { color: #7f8c8d; font-weight: 600; margin: 0; }

        /* INPUT FIELD STYLES */
        .input-group { margin-bottom: 25px; text-align: left; width: 100%; max-width: 400px; margin-left: auto; margin-right: auto; }
        .input-label { display: block; font-weight: 700; margin-bottom: 10px; color: var(--dark); font-size: 1.1rem; }
        .name-input {
            width: 100%; padding: 15px 20px; font-size: 1.2rem;
            border: 2px solid #e0e6ed; border-radius: 15px;
            font-family: 'Nunito', sans-serif; outline: none; transition: border-color 0.2s;
            background: white; /* Ensure select has background */
        }
        .name-input:focus { border-color: var(--primary); }

        .progress-container {
            background: #eef2f5; height: 14px; border-radius: 50px;
            margin: 0 0 30px; overflow: hidden;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), #ffcb05);
            width: 0%; border-radius: 50px;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .question-box {
            font-size: 1.35rem; font-weight: 700; color: var(--dark);
            margin-bottom: 30px; line-height: 1.5;
        }

        .q-img {
            max-width: 100%; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin: 20px 0; border: 4px solid #fff;
        }
        .opt-img { max-height: 80px; object-fit: contain; pointer-events: none; }

        .options-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;
        }

        @media (max-width: 600px) {
            .options-grid { grid-template-columns: 1fr; }
        }

        .option-btn {
            background: white;
            border: 2px solid #e0e6ed; border-bottom: 6px solid #e0e6ed;
            padding: 20px; border-radius: 20px;
            font-size: 1.1rem; color: var(--text-main); font-weight: 700;
            cursor: pointer; transition: all 0.15s ease;
            position: relative; font-family: 'Nunito', sans-serif;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        .option-btn:hover:not(:disabled) {
            border-color: var(--secondary); border-bottom-color: var(--secondary-dark);
            background: #f0fffd; transform: translateY(-2px);
        }
        .option-btn:active:not(:disabled) {
            transform: translateY(4px); border-bottom-width: 2px; margin-top: 4px;
        }
        .option-btn:disabled { opacity: 0.8; cursor: default; }

        .option-btn.correct {
            background: #d1f7c4; border-color: #2ecc71; border-bottom-color: #27ae60; color: #27ae60;
        }
        .option-btn.wrong {
            background: #fadbd8; border-color: #e74c3c; border-bottom-color: #c0392b; color: #c0392b;
        }

        /* Report variant */
        .option-btn.report-variant {
            padding: 15px; font-size: 1rem; min-height: auto;
            border-bottom-width: 3px; cursor: default; pointer-events: none;
        }
        .report-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 100%; }
        @media(max-width: 600px) { .report-grid { grid-template-columns: 1fr !important; } }

        .btn {
            background: var(--primary); color: white; border: none;
            border-bottom: 5px solid var(--primary-dark);
            padding: 18px 40px; font-size: 1.2rem; border-radius: 50px;
            font-weight: 800; cursor: pointer; transition: all 0.1s;
            font-family: 'Nunito', sans-serif; text-transform: uppercase; letter-spacing: 1px;
            display: inline-block; margin-top: 20px; width: 100%;
        }
        .btn:active { transform: translateY(3px); border-bottom-width: 2px; margin-top: 23px; }
        .btn-next { background: var(--secondary); border-bottom: 5px solid var(--secondary-dark); }
        .btn-report { background: white; color: var(--dark); border: 2px solid #ddd; border-bottom: 5px solid #ccc; margin-top: 15px; }
        .btn-report:active { border-bottom-width: 2px; margin-top: 18px; }
        .btn-dashboard { background: #34495e; border-bottom: 5px solid #2c3e50; font-size: 0.9rem; margin-top: 10px; width: auto; padding: 10px 20px; }

        .feedback-msg { font-size: 1.4rem; font-weight: 800; margin-bottom: 15px; }

        /* Checkpoint Overlay */
        .checkpoint-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(1, 22, 39, 0.9); z-index: 200;
            display: none; justify-content: center; align-items: center;
            flex-direction: column; animation: fadeIn 0.3s ease; backdrop-filter: blur(5px);
        }
        .checkpoint-content {
            background: white; padding: 40px; border-radius: 30px;
            text-align: center; max-width: 400px; width: 90%;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            animation: zoomIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative; overflow: hidden;
        }
        .checkpoint-content::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 10px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        /* Report Card */
        .report-card {
            display: none; margin-top: 30px; text-align: left;
            background: #fff; border-radius: 15px; border: 2px solid #eee;
            overflow: hidden; animation: slideUp 0.3s ease;
        }
        .report-header { background: var(--dark); color: white; padding: 15px 20px; font-weight: 800; font-size: 1.1rem; }
        .report-list { padding: 0; margin: 0; list-style: none; max-height: 500px; overflow-y: auto; }
        .report-item { padding: 25px 20px; border-bottom: 4px solid #f0f4f8; font-size: 0.95rem; }
        .report-item:last-child { border-bottom: none; }
        .report-meta { display: inline-block; background: #e3f2fd; color: #1565c0; padding: 3px 10px; border-radius: 15px; font-size: 0.75rem; font-weight: 800; margin-bottom: 15px; text-transform: uppercase; }
        .report-q-text { margin-bottom: 20px; font-weight: 700; color: var(--dark); font-size: 1.1rem; }
        .report-q-text img { max-width: 100%; height: auto; max-height: 200px; display: block; margin: 10px 0; border-radius: 8px; border: 1px solid #eee; }

        .screen { display: none; width: 100%; }
        .screen.active { display: block; }

        .result-level { font-size: clamp(2rem, 8vw, 3.5rem); font-weight: 900; color: white; text-shadow: 2px 2px 0 rgba(0,0,0,0.1); word-wrap: break-word; line-height: 1.1; }
        .result-card-inner {
            background: linear-gradient(135deg, #FF9F1C, #FF5E00);
            padding: 40px; border-radius: 30px; color: white; margin: 20px 0;
            position: relative; overflow: hidden; box-shadow: 0 15px 30px rgba(255, 159, 28, 0.4);
        }
        .result-card-inner::before {
            content: 'üèÜ'; position: absolute; font-size: 10rem; opacity: 0.1;
            right: -20px; bottom: -20px; transform: rotate(-15deg);
        }
    </style>
</head>
<body>

<div class="app-container">
    <!-- HEADER -->
    <header>
        <img src="https://imgix3.ruangguru.com/assets/miscellaneous/png_aaojxe_9962.png" alt="Math Champs" class="logo">
        <div class="status-bar" id="statusBar" style="visibility: hidden;">
            <!-- Timer (Sekarang Hidden) -->
            <div class="status-item" style="display: none;">
                <span>‚è±Ô∏è</span> <span id="timerDisplay">60:00</span>
            </div>
        </div>
    </header>

    <!-- MAIN GAME STAGE -->
    <div class="game-stage">
        <div class="content-card">
            
            <!-- SCREEN 0: INPUT NAME & CLASS -->
            <div id="inputNameScreen" class="screen active" style="text-align: center;">
                <div style="font-size: 4rem; margin-bottom: 10px;">üëã</div>
                <h1>Halo, Champion!</h1>
                <h2 style="margin-bottom: 40px;">Lengkapi data dirimu</h2>
                
                <div class="input-group">
                    <label class="input-label">Nama Lengkap</label>
                    <input type="text" id="studentNameInput" class="name-input" placeholder="Tulis namamu di sini..." autocomplete="off">
                </div>

                <div class="input-group">
                    <label class="input-label">Kelas</label>
                    <select id="studentClassInput" class="name-input">
                        <option value="1">Kelas 1</option>
                        <option value="2">Kelas 2</option>
                        <option value="3">Kelas 3</option>
                        <option value="4">Kelas 4</option>
                        <option value="5">Kelas 5</option>
                        <option value="6">Kelas 6</option>
                        <option value="7">Kelas 7</option>
                        <option value="8">Kelas 8</option>
                        <option value="9">Kelas 9</option>
                    </select>
                </div>

                <button class="btn" onclick="saveNameAndContinue()">Lanjut</button>
            </div>

            <!-- SCREEN 1: START (UPDATED TO MATCH IMAGE 2) -->
            <div id="startScreen" class="screen" style="text-align: center;">
                <div style="font-size: 4rem; margin-bottom: 10px;">üî•</div>
                <h1>PLACEMENT TEST</h1>
                <h2 style="margin-bottom: 30px;">Uji Kemampuan Matematika Kamu</h2>

                <div style="background: #FFF8E1; padding: 25px; border-radius: 20px; text-align: left; border: 2px solid #FFE082; margin-bottom: 30px;">
                    <h3 style="margin: 0 0 15px 0; color: #F57F17;">üìú Cara Kerja Tes:</h3>
                    <ul style="margin: 0; padding-left: 20px; color: #5d4037; font-size: 1.1rem; line-height: 1.6;">
                        <li>Tes dimulai dari <strong>soal yang kami pilih khusus kamu</strong>.</li>
                        <li>Sistem akan menyesuaikan soal menjadi lebih mudah/sulit berdasarkan jawabanmu.</li>
                    </ul>
                </div>

                <button class="btn" onclick="startGame()">MULAI SEKARANG üöÄ</button>
            </div>

            <!-- SCREEN 2: GAME -->
            <div id="gameScreen" class="screen">
                <div class="progress-container">
                    <div class="progress-fill" id="progressBar"></div>
                </div>
                <div class="question-box" id="questionText"></div>
                <div class="options-grid" id="optionsContainer"></div>
            </div>

            <!-- SCREEN 3: RESULT -->
            <div id="resultScreen" class="screen" style="text-align: center;">
                <h1>Tes Selesai! üéâ</h1>
                <p style="font-size: 1.2rem; color: #7f8c8d;">Level kamu sudah ditemukan!</p>
                <div class="result-card-inner">
                    <div style="font-size: 1rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 2px;">Level Rekomendasi</div>
                    <div class="result-level" id="finalPlacement">...</div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 30px;">
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; border: 2px solid #eee;">
                        <div style="font-size: 2rem; font-weight: 900; color: var(--dark);" id="finalScore">0</div>
                        <div style="color: #95a5a6; font-size: 0.9rem; font-weight: 700;">TOTAL BENAR</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; border: 2px solid #eee;">
                        <div style="font-size: 2rem; font-weight: 900; color: var(--dark);" id="timeUsed">00:00</div>
                        <div style="color: #95a5a6; font-size: 0.9rem; font-weight: 700;">WAKTU</div>
                    </div>
                </div>
                <button class="btn btn-report" onclick="toggleReport()" id="btnReportToggle">üìã Lihat Detail Jawaban Salah</button>
                
                <div id="reportCard" class="report-card">
                    <div class="report-header">
                        <span>Analisis Kesalahan</span>
                    </div>
                    <ul id="reportList" class="report-list"></ul>
                </div>
            </div>
            
            <!-- FEEDBACK AREA -->
            <div class="feedback-container" id="feedbackArea">
                <div class="feedback-msg" id="feedbackMessage">Jawaban Benar!</div>
                <button class="btn btn-next" id="nextBtn">Lanjut ‚ûî</button>
            </div>
            
            <!-- CHECKPOINT MODAL -->
            <div id="checkpointModal" class="checkpoint-overlay">
                <div class="checkpoint-content">
                    <div style="font-size: 4rem; margin-bottom: 10px;">‚öñÔ∏è</div>
                    <h2 style="color: var(--primary); font-size: 1.8rem; margin-bottom: 10px;">ANALISIS SELESAI</h2>
                    <p style="font-size: 1.1rem; color: #555;">Kami sedang menyesuaikan tingkat kesulitan soal...</p>
                    <p id="checkpointMsg" style="color: #27ae60; font-weight: bold; margin: 15px 0;">...</p>
                    <button class="btn" onclick="closeCheckpoint()">LANJUT ‚ñ∂</button>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // --- GOOGLE APPS SCRIPT URL ---
    // UPDATED URL HERE
    const googleScriptURL = 'https://script.google.com/macros/s/AKfycbzMl3Pu09iaRfqAatkPCqYQ11qIYoAAwsVEEv0m6Tu-Qsit-GseZKBwwGlcE4Xr4pCJMw/exec';

    // 1. DATA SOAL BARU (Updated to GitHub Links)
    const questions = [
        // --- Discovery 1 (Soal 1-5) ---
        { 
            level: "Discovery 1", 
            text: "Perhatikan gambar di bawah ini.<br><img src='https://mathruangguru.github.io/gambar/bola_1.png' class='q-img' alt='Gambar Bola Basket dan Voli'><br>Pilih jawaban yang sesuai dengan gambar di atas.", 
            options: ["Jumlah bola basket 2 lebih banyak dari jumlah bola voli", "Jumlah bola voli 2 lebih sedikit dari jumlah bola basket", "Jumlah bola basket dan bola voli adalah 9", "Jumlah bola basket lebih sedikit dari jumlah bola voli"], 
            answer: 0 
        },
        { 
            level: "Discovery 1", 
            text: "11 anak sedang berbaris dalam sebuah antrean untuk membeli es krim. Ada <strong>5 anak di belakang Ron</strong>. Ron berada pada posisi ke-berapa dari depan?", 
            options: ["Ke-5", "Ke-6", "Ke-7", "Ke-10"], 
            answer: 1 
        },
        { 
            level: "Discovery 1", 
            text: "Gambar-gambar di bawah ini menunjukkan ikatan bilangan (number bonds).<br><img src='https://mathruangguru.github.io/gambar/bonda_3.png' class='q-img' alt='Contoh Number Bonds'><br>Diberikan ikatan bilangan berantai di bawah ini.<br><img src='https://mathruangguru.github.io/gambar/bondb_3.png' class='q-img' alt='Soal Number Bonds'><br>Berapakah nilai dari ‚òÜ?", 
            options: ["4", "3", "2", "1"], 
            answer: 2 
        },
        { 
            level: "Discovery 1", 
            text: "Berikut ini adalah gambar 4 buah penjepit.<br><img src='https://mathruangguru.github.io/gambar/paperclip_4.png' class='q-img'><br>Selisih panjang penjepit terpanjang dengan penjepit terpendek adalah ___ satuan.", 
            options: ["1", "2", "3", "4"], 
            answer: 3 
        },
        { 
            level: "Discovery 1", 
            text: "Rara memiliki <strong>2 balon lebih banyak</strong> dari Riri. Jumlah semua balon Rara dan Riri adalah <strong>8 balon</strong>. Berapa balon Riri?", 
            options: ["3 balon", "4 balon", "5 balon", "6 balon"], 
            answer: 0 
        },
        
        // --- Discovery 2 (Soal 6-10) ---
        { level: "Discovery 2", text: "Pilih gambar atau angka yang menunjukkan jumlah <strong>terbanyak</strong>.", options: ["<img src='https://mathruangguru.github.io/gambar/barA_6.png' class='opt-img'>", "<img src='https://mathruangguru.github.io/gambar/tenB_6.png' class='opt-img'>", "23", "2 puluhan, 5 satuan"], answer: 3 },
        { level: "Discovery 2", text: "Joan membeli 3 ekor ikan hias.<br>Robin membeli 2 ekor ikan hias <strong>lebih banyak</strong> dari Joan.<br>Berapa banyak <strong>jumlah semua</strong> ikan hias milik Joan dan Robin?", options: ["5 ekor", "8 ekor", "12 ekor", "13 ekor"], answer: 1 },
        { 
            level: "Discovery 2", 
            text: "Beni sedang sakit. Ia tertidur dan terbangun pada jam yang ditunjukkan pada gambar di bawah ini.<br><img src='https://mathruangguru.github.io/gambar/jam_8.png' class='q-img' alt='Gambar Jam'><br>Berapa jam Beni tertidur?", 
            options: ["4 jam", "5 jam", "6 jam", "7 jam"], 
            answer: 1 
        },
        { level: "Discovery 2", text: "Pilih satu yang <strong>hasilnya berbeda</strong>.", options: ["\\( 2 \\times 3 \\)", "\\( 4 + 3 \\)", "\\( 9 - 3 \\)", "\\( 12 \\div 2 \\)"], answer: 1 },
        { level: "Discovery 2", text: "Grafik berikut menunjukkan jumlah bintang yang dikumpulkan 3 orang siswa dalam satu semester.<br><img src='https://mathruangguru.github.io/gambar/diag_10.png' class='q-img'><br>Setiap bintang (\\(\\star\\)) mewakili 5 poin. Jumlah total poin yang didapatkan oleh <strong>Evelyn</strong> adalah...", options: ["10 poin", "15 poin", "20 poin", "30 poin"], answer: 1 },
        
        // --- Discovery 3 (Soal 11-15) ---
        { level: "Discovery 3", text: "Perhatikan dua gambar di bawah ini.<br><img src='https://mathruangguru.github.io/gambar/blocks_11.png' class='q-img'><br>Berapa <strong>selisih jumlah kubus</strong> dari kedua gambar di atas?", options: ["4", "40", "136", "100"], answer: 2 },
        { level: "Discovery 3", text: "Di lapangan ada 17 anak-anak, baik laki-laki dan perempuan. Jumlah anak laki-laki <strong>5 lebih sedikit</strong> dari jumlah anak perempuan. Ada berapa anak perempuan yang sedang berada di lapangan?", options: ["5 anak", "6 anak", "11 anak", "12 anak"], answer: 2 },
        { level: "Discovery 3", text: "Tinggi kakak 1 meter, 8 centimeter.<br>Tinggi adik 91 centimeter.<br>Berapa <strong>selisih</strong> tinggi kakak dan adik?", options: ["15 cm", "16 cm", "17 cm", "18 cm"], answer: 2 },
        { level: "Discovery 3", text: "Perhatikan pola berikut:<br>‚ñ≥ ‚ñ¢ ‚òÜ ‚óØ ‚ñ≥ ‚ñ¢ ‚òÜ ‚óØ ‚ñ≥ ‚ñ¢ ‚òÜ ‚óØ ‚ñ≥ ...<br>Gambar apakah yang ada di <strong>urutan ke-27</strong>?", options: ["‚ñ≥ (Segitiga)", "‚ñ¢ (Persegi)", "‚òÜ (Bintang)", "‚óØ (Lingkaran)"], answer: 2 },
        { level: "Discovery 3", text: "Cari hasil pembagian berikut.<br>\\[ 25 \\div 6 = \\dots \\]", options: ["3", "4", "3 sisa 5", "4 sisa 1"], answer: 3 },
        
        // --- Discovery 4 (Soal 16-20) ---
        { level: "Discovery 4", text: "Perhatikan gambar di bawah ini. Manakah gambar yang menunjukkan <strong>pecahan yang berbeda</strong> dari yang lain?<br><img src='https://mathruangguru.github.io/gambar/fracs_16.png' class='q-img'>", options: ["Gambar A", "Gambar B", "Gambar C", "Gambar D"], answer: 3 },
        { level: "Discovery 4", text: "Perhatikan sekumpulan bilangan di bawah ini.<br>\\[ 14 + 28 + 12 + 7 + 16 + 13 = \\dots \\]<br>Jumlah dari seluruh bilangan di atas adalah...", options: ["88", "89", "90", "91"], answer: 2 },
        { level: "Discovery 4", text: "Berapa <strong>selisih</strong> jumlah <strong>sisi</strong> dengan jumlah <strong>titik sudut</strong> pada sebuah limas segiempat?<br><img src='https://mathruangguru.github.io/gambar/limas_18.png' class='q-img'>", options: ["4", "3", "1", "0"], answer: 3 },
        { level: "Discovery 4", text: "Tuliskan bilangan yang tepat untuk melengkapi kalimat matematika di bawah ini.<br>\\[ 16 + 2 - \\_\\_ = 12 \\]", options: ["5", "6", "7", "8"], answer: 1 },
        { level: "Discovery 4", text: "Hendro menggunakan 1 lembar Rp50.000 untuk membayar pembelian mobil-mobilan. Penjual memberi kembalian 2 lembar Rp5.000 dan 1 lembar Rp2.000. Berapakah <strong>harga mobil-mobilan</strong> tersebut?", options: ["10.000", "12.000", "24.000", "38.000"], answer: 3 },
        
        // --- Exploration 1 (Soal 21-25) ---
        { level: "Exploration 1", text: "Diberikan 4 angka berikut ini: 6, 1, 8, 5.<br>Berapakah <strong>bilangan genap 3 digit terbesar</strong> yang dapat dibentuk dari angka-angka yang diberikan di atas?", options: ["865", "861", "856", "816"], answer: 2 },
        { level: "Exploration 1", text: "Tuliskan bilangan yang tepat untuk melengkapi kalimat matematika di bawah ini.<br>\\[ \\_\\_ + 4 \\times 3 = 15 \\]", options: ["3", "1", "7", "5"], answer: 0 },
        { level: "Exploration 1", text: "Panjang sebuah jalan raya adalah 60 m. Ibu walikota berencana untuk menanamkan pohon dari satu ujung jalan ke ujung jalan yang lain. Jika <strong>jarak antar pohon</strong> adalah 5 meter, ada berapa pohon yang ditanam oleh ibu walikota?", options: ["10 pohon", "11 pohon", "12 pohon", "13 pohon"], answer: 3 },
        { level: "Exploration 1", text: "Tuliskan bilangan yang tepat untuk melengkapi kalimat matematika di bawah ini.<br>\\[ 3 \\times 8 : \\_\\_ = 4 \\]", options: ["4", "5", "6", "8"], answer: 2 },
        { level: "Exploration 1", text: "Perhatikan diagram batang (tidak lengkap) di bawah ini.<br><img src='https://mathruangguru.github.io/gambar/laptop_25.png' class='q-img'><br>Diketahui bahwa:<br>Laptop yang terjual pada bulan Februari dua kali lebih banyak dibandingkan dengan laptop yang terjual pada bulan Januari.<br>Penjualan pada bulan Maret 20 laptop lebih sedikit dari bulan Februari.<br>Berapakah jumlah laptop yang terjual pada <strong>bulan Januari</strong>?", options: ["10", "20", "30", "40"], answer: 2 },
        
        // --- Exploration 2 (Soal 26-30) ---
        { level: "Exploration 2", text: "Jumlah penonton konser adalah 4.582 orang. Panitia konser mencatat jumlah penonton konser tersebut dengan <strong>pembulatan ke ratusan terdekat</strong>. Tuliskan lambang bilangan yang dicatat oleh panitia konser.", options: ["4.500", "4.600", "4.580", "5.000"], answer: 1 },
        { level: "Exploration 2", text: "Tuliskan bilangan yang tepat untuk melengkapi kalimat matematika di bawah ini.<br>\\[ \\frac{1}{3} + \\frac{1}{2} = \\dots \\]", options: ["\\(\\frac{1}{6}\\)", "\\(\\frac{5}{6}\\)", "\\(\\frac{2}{3}\\)", "\\(\\frac{2}{5}\\)"], answer: 1 },
        { level: "Exploration 2", text: "Keliling sebuah persegi adalah 24 cm. <strong>Luas</strong> persegi tersebut adalah ... \\( \\text{cm}^2 \\).", options: ["18", "24", "30", "36"], answer: 3 },
        { level: "Exploration 2", text: "Kelas 3A terdiri dari 27 siswa. Jika \\(\\frac{2}{3}\\) dari seluruh kelas adalah penggemar Shakira, berapa siswa kelas 3A yang adalah <strong>penggemar</strong> Shakira?", options: ["9 siswa", "12 siswa", "18 siswa", "21 siswa"], answer: 2 },
        { level: "Exploration 2", text: "Perhatikan diagram batang di bawah ini.<br><img src='https://mathruangguru.github.io/gambar/mal_30.png' class='q-img'><br>Dari data yang diberikan, berapa <strong>jumlah pengunjung harian paling sedikit</strong>?", options: ["120 orang", "130 orang", "140 orang", "160 orang"], answer: 3 },
        
        // --- Exploration 3 (Soal 31-35) ---
        { level: "Exploration 3", text: "Aku adalah <strong>bilangan genap dua digit terbesar</strong> yang <strong>habis dibagi 3</strong>. Berapakah aku?", options: ["99", "98", "96", "93"], answer: 2 },
        { level: "Exploration 3", text: "Hitung hasil operasi bilangan di bawah ini.<br>\\[ 32 \\times 14 + 16 \\times 12 + 8 \\times 20 = \\dots \\]", options: ["750", "800", "850", "900"], answer: 1 },
        { level: "Exploration 3", text: "Nena membeli kelereng dari dua toko: Toko A dan Toko B.<br>Toko A menjual kelereng dalam satuan kodi (20 buah).<br>Toko B menjual kelereng dalam satuan lusin (12 buah).<br>Nena membeli 3 kodi dari toko A dan 4 lusin dari toko B.<br>Berapa <strong>jumlah kelereng</strong> yang Nena beli?", options: ["100 butir", "108 butir", "112 butir", "120 butir"], answer: 1 },
        { level: "Exploration 3", text: "Dari beberapa perhitungan di bawah ini, cari yang <strong>hasil perhitungannya berbeda</strong> dari yang lain.", options: ["\\( 18 \\times 25 \\)", "\\( 35 \\times 12 \\)", "\\( 70 \\times 6 \\)", "\\( 140 \\times 3 \\)"], answer: 0 },
        { level: "Exploration 3", text: "Terdapat 360 kaleng minuman ringan. Kaleng-kaleng tersebut dimasukkan ke dalam dus-dus kecil dengan kapasitas 12 kaleng. Kemudian, dus-dus kecil tersebut dimasukkan ke dalam dus besar yang memuat 6 dus kecil. Ada berapa <strong>dus besar</strong> yang berisi dus-dus kecil yang terisi penuh dengan kaleng?", options: ["5 dus besar", "6 dus besar", "7 dus besar", "8 dus besar"], answer: 0 },
        
        // --- Exploration 4 (Soal 36-40) ---
        { level: "Exploration 4", text: "Pilih hasil yang tepat untuk operasi bilangan pecahan di bawah ini.<br>\\[ \\frac{1}{2} + \\frac{1}{3} - \\frac{1}{4} - \\frac{1}{5} = \\dots \\]", options: ["\\(\\frac{7}{20}\\)", "\\(\\frac{23}{60}\\)", "\\(\\frac{5}{12}\\)", "\\(\\frac{3}{4}\\)"], answer: 1 },
        { level: "Exploration 4", text: "Perhatikan gambar di bawah ini.<br><img src='https://mathruangguru.github.io/gambar/ungu_37.png' class='q-img'><br>Pilih bentuk penulisan bilangan yang <strong>tidak sesuai</strong> dengan gambar di atas.", options: ["\\( 2\\frac{1}{3} \\)", "\\( \\frac{7}{3} \\)", "7 pertiga", "2,33"], answer: 3 },
        { level: "Exploration 4", text: "Juno sedang mengukur massa sebungkus jeruk dengan neraca. Neraca seimbang ketika Juno menempatkan:<br><ul><li>2 bandul 1 kg</li><li>1 bandul 500 g</li><li>3 bandul 100 g</li></ul><br>Ada 8 jeruk dalam bungkusan tersebut. Jika massa jeruk dianggap sama, berapa <strong>massa 1 jeruk</strong> dalam satuan kilogram dibulatkan ke persepuluhan terdekat?", options: ["0,3 kg", "0,4 kg", "0,35 kg", "3,5 kg"], answer: 1 },
        { level: "Exploration 4", text: "Manakah gambar yang menunjukkan <strong>segitiga tumpul sembarang</strong>?", options: ["<img src='https://mathruangguru.github.io/gambar/triA_39.png' class='opt-img'>", "<img src='https://mathruangguru.github.io/gambar/triB_39.png' class='opt-img'>", "<img src='https://mathruangguru.github.io/gambar/triC_39.png' class='opt-img'>", "<img src='https://mathruangguru.github.io/gambar/triD_39.png' class='opt-img'>"], answer: 2 },
        { level: "Exploration 4", text: "Diagram garis di bawah ini menunjukkan suhu udara harian di kota Zula.<br><img src='https://mathruangguru.github.io/gambar/suhu_40.png' class='q-img'><br><strong>Kenaikan suhu terbesar</strong> terjadi dari tanggal ...", options: ["21 ke 22 Maret", "22 Maret ke 23 Maret", "23 Maret ke 24 Maret", "25 Maret ke 26 Maret"], answer: 3 },
        
        // --- Mastery 1 (Soal 41-45) ---
        { level: "Mastery 1", text: "Cari hasil operasi bilangan di bawah ini.<br>\\[ 88 \\times 125 - 18 \\times 50 - 24 \\times 25 - 2 \\times 100 = \\dots \\]", options: ["9.100", "9.200", "9.300", "9.400"], answer: 2 },
        { level: "Mastery 1", text: "Lina mempunyai \\(3\\frac{1}{4}\\) meter pita merah di rumahnya. Dia membeli tambahan \\(2\\frac{2}{3}\\) meter lagi untuk mendekorasi kelasnya. Pita merah yang terpakai untuk mendekorasi kelas adalah \\(4\\frac{5}{6}\\) meter. Berapa meter sisa pita merah yang ia miliki?", options: ["1 meter", "\\(\\frac{13}{12}\\) meter", "\\(2\\frac{1}{12}\\) meter", "3 meter"], answer: 1 },
        { level: "Mastery 1", text: "Perhatikan dua kubus di bawah ini.<br><img src='https://mathruangguru.github.io/gambar/cube_43.png' class='q-img'><br>Diketahui panjang sisi kubus B <strong>3 kali lebih panjang</strong> dari panjang sisi kubus A. Jika volume kubus A adalah \\( 5~\\text{cm}^3 \\), volume kubus B adalah ... \\(\\text{cm}^3\\).", options: ["15", "45", "135", "375"], answer: 2 },
        { level: "Mastery 1", text: "Ibu membuat sejumlah kue. \\(\\frac{1}{2}\\) dari seluruh kue diberikan kepada nenek. \\(\\frac{2}{3}\\) dari sisanya diberikan kepada bibi. Jika jumlah kue yang tersisa adalah 5, berapakah jumlah kue yang ibu buat?", options: ["20 kue", "25 kue", "30 kue", "35 kue"], answer: 2 },
        { level: "Mastery 1", text: "Cari kecepatan yang <strong>berbeda</strong> dari yang lain.", options: ["\\( 60~\\text{km/jam} \\)", "\\( 1~\\text{km/menit} \\)", "\\( 16\\frac{2}{3}~\\text{m/detik} \\)", "\\( 1000~\\text{km/menit} \\)"], answer: 3 },
        
        // --- Mastery 2 (Soal 46-50) ---
        { level: "Mastery 2", text: "Hitunglah hasil dari: \\( 20 - 12 : 4 + 3 \\times 2 = \\dots \\)", options: ["10", "16", "23", "25"], answer: 2 },
        { level: "Mastery 2", text: "Ali membelanjakan uangnya <strong>5 kali lebih banyak</strong> daripada Baba di sebuah toko. Ali membayar dengan selembar uang 20 ribuan dan menerima kembalian 2 ribu rupiah. Berapa banyak yang dibelanjakan Baba?", options: ["Rp 3.000", "Rp 3.600", "Rp 4.000", "Rp 4.500"], answer: 1 },
        { level: "Mastery 2", text: "Pilih gambar dengan <strong>luas yang berbeda</strong>.", options: ["<img src='https://mathruangguru.github.io/gambar/luasA_48.png' class='opt-img'>", "<img src='https://mathruangguru.github.io/gambar/luasB_48.png' class='opt-img'>", "<img src='https://mathruangguru.github.io/gambar/luasC_48.png' class='opt-img'>", "<img src='https://mathruangguru.github.io/gambar/luasD_48.png' class='opt-img'>"], answer: 2 },
        { level: "Mastery 2", text: "Sebuah bak mandi berbentuk balok akan terisi penuh dengan 450 liter air. Jika panjang bak mandi adalah 1 m dan lebar bak mandi 60 cm, berapakah tinggi bak mandi tersebut?", options: ["50 cm", "60 cm", "75 cm", "80 cm"], answer: 2 },
        { level: "Mastery 2", text: "Tabel di bawah ini menunjukkan nilai ujian akhir matematika dari 5 orang siswa.<br><img src='https://mathruangguru.github.io/gambar/tabel_50.png' class='q-img'><br>Ada berapa anak yang nilainya <strong>di atas rata-rata</strong> dari kelima siswa tersebut?", options: ["2 orang", "3 orang", "4 orang", "5 orang"], answer: 1 },
        
        // --- Mastery 3 (Soal 51-55) ---
        { level: "Mastery 3", text: "Diketahui:<br>\\( A : B = 1 : 3 \\)<br>\\( B : C = 4 : 9 \\)<br>\\( C = 81 \\)<br>Cari nilai A.", options: ["9", "12", "15", "18"], answer: 1 },
        { level: "Mastery 3", text: "\\(\\frac{1}{3}\\) uang Andi sama dengan \\(\\frac{2}{5}\\) uang Budi. Jika selisih uang mereka Rp5.000, berapa total uang keduanya?", options: ["Rp5.000", "Rp25.000", "Rp30.000", "Rp55.000"], answer: 3 },
        { level: "Mastery 3", text: "Sebuah segitiga sama kaki memiliki dua sudut yang sama besar dan satu sudut lain yang berbeda. Sudut yang berbeda itu merupakan sudut terbesar segitiga dan besarnya \\(70^{\\circ}\\). Berapakah hasil penjumlahan kedua sudut yang lain?", options: ["\\( 100^{\\circ} \\)", "\\( 110^{\\circ} \\)", "\\( 120^{\\circ} \\)", "\\( 140^{\\circ} \\)"], answer: 1 },
        { level: "Mastery 3", text: "Harga mainan kesukaan kakak <strong>naik 20%</strong> dibandingkan dengan harga sebelumnya. Jika harga sekarang adalah Rp72.000, berapa harga mainan tersebut sebelum mengalami kenaikan?", options: ["Rp 57.600", "Rp 60.000", "Rp 64.000", "Rp 65.000"], answer: 1 },
        { level: "Mastery 3", text: "Rata-rata dari 4 bilangan adalah 9. Jika salah satu bilangan dibuang, rata-ratanya menjadi 8. Berapakah <strong>bilangan yang dibuang</strong> tersebut?", options: ["8", "10", "12", "14"], answer: 2 },
        
        // --- Mastery 4 (Soal 56-60) ---
        { level: "Mastery 4", text: "Perhatikan perhitungan berbagai bilangan pecahan di bawah ini.<br>\\[ \\frac{2}{3} + \\frac{3}{4} \\times \\frac{6}{7} - \\frac{3}{4} \\div \\frac{3}{2} = \\frac{a}{b} \\]<br>Jika hasil akhirnya adalah dalam bentuk yang paling sederhana, \\( a + b \\) adalah ...", options: ["19", "38", "45", "57"], answer: 1 },
        { level: "Mastery 4", text: "Merisa menggunakan \\(\\frac{3}{4}\\) uangnya untuk membeli sebuah buku. Kemudian, ia menggunakan \\(\\frac{1}{2}\\) dari sisanya untuk membeli sebuah kalkulator. Jika harga buku Rp30.000 lebih mahal dari harga kalkulator, berapakah harga buku tersebut?", options: ["Rp30.000", "Rp36.000", "Rp60.000", "Rp75.000"], answer: 1 },
        { level: "Mastery 4", text: "Perhatikan gambar di bawah ini.<br><img src='https://mathruangguru.github.io/gambar/shape_58.png' class='q-img'><br>Gambar di atas terbentuk dari sebuah persegi dengan panjang sisi 10 cm dan seperempat lingkaran. Berapakah <strong>luas daerah yang diarsir</strong>? Gunakan pendekatan \\(\\pi \\approx 3,14\\).", options: ["\\(21,5~\\text{cm}^2\\)", "\\(22~\\text{cm}^2\\)", "\\(22,5~\\text{cm}^2\\)", "\\(23~\\text{cm}^2\\)"], answer: 0 },
        { level: "Mastery 4", text: "Pada pk. 07.00, seorang anak bersepeda dari rumah ke perpustakaan dengan kecepatan \\(18~\\text{km/jam}.\\) Setelah 20 menit berselang, ibunya menyusul dengan sepeda listrik dengan kecepatan \\(24~\\text{km/jam}.\\) Jika jalan dari rumah ke perpustakaan lurus dan kecepatan mereka konstan, pada pukul berapa ibu tersebut akan menyusul anaknya?", options: ["08.00", "08.10", "08.20", "08.30"], answer: 2 },
        { level: "Mastery 4", text: "Pada suatu kelas olahraga, diketahui 24% peserta mengikuti permainan voli. Sudut pembentuk juring bertuliskan SEPAKBOLA pada diagram lingkaran adalah 144¬∞. Jika jumlah seluruh peserta kelas olahraga adalah 50 orang, berapa <strong>peserta yang mengikuti permainan basket</strong>?<br><img src='https://mathruangguru.github.io/gambar/pie_60.png' class='q-img'>", options: ["12 orang", "15 orang", "18 orang", "20 orang"], answer: 2 }
    ];

    // 2. STATE & CONFIG
    // Urutan Level dari termudah ke tersulit
    const LEVEL_ORDER = [
        "Discovery 1", "Discovery 2", "Discovery 3", "Discovery 4",
        "Exploration 1", "Exploration 2", "Exploration 3", "Exploration 4",
        "Mastery 1", "Mastery 2", "Mastery 3", "Mastery 4"
    ];

    let studentName = "";
    let studentClass = "";  // Tambahan state untuk menyimpan kelas
    let minIndex = 0;
    let maxIndex = LEVEL_ORDER.length - 1;
    let currentLevelIndex = 0;
    let startLevelOverride = null;  // NEW: State for class-based override

    let questionsInCurrentLevel = [];
    let currentQuestionPointer = 0;
    let currentLevelScore = 0;
    let currentLevelWrong = 0; // NEW: Track consecutive wrongs in a level
    let totalCorrectAnswers = 0;
    let timeRemaining = 3600;
    let timerInterval;
    let isAnswering = true;
    let wrongAnswers = [];
    let bestLevelReached = "Foundation";

    // --- MAIN FUNCTIONS ---

    window.onload = function() {
        // Reset state on load
        minIndex = 0;
        maxIndex = LEVEL_ORDER.length - 1;
    };

    window.saveNameAndContinue = function() {
        const name = document.getElementById('studentNameInput').value.trim();
        const cls = document.getElementById('studentClassInput').value; // Ambil nilai kelas
        
        if (name) {
            studentName = name;
            studentClass = cls; // Simpan kelas
            inputNameScreen.classList.remove('active');
            startScreen.classList.add('active');
        } else {
            alert("Silakan masukkan nama kamu.");
        }
    };

    window.startGame = function() {
        startScreen.classList.remove('active');
        gameScreen.classList.add('active');
        statusBar.style.visibility = 'visible';

        // Determinisikan Start Level Berdasarkan Kelas (Updated Logic - REQUEST 1)
        const classVal = parseInt(studentClass || document.getElementById('studentClassInput').value);
        
        // MAPPING BARU: KELAS 1-9 ke INDEX 0-8
        // Kelas 1 -> Discovery 1 (Index 0)
        // Kelas 2 -> Discovery 2 (Index 1)
        // ...
        // Kelas 9 -> Mastery 1 (Index 8)
        
        if (classVal >= 1 && classVal <= 9) {
            startLevelOverride = classVal - 1; 
        } else {
            startLevelOverride = 0; // Fallback ke Discovery 1
        }

        // RESET VARS
        minIndex = 0;
        maxIndex = LEVEL_ORDER.length - 1;
        totalCorrectAnswers = 0;
        wrongAnswers = [];
        bestLevelReached = "Placement Start";

        // TIMER (Hidden UI)
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            timeRemaining--;
            if(timeRemaining >= 0) {
                let m = Math.floor(timeRemaining / 60);
                let s = timeRemaining % 60;
                document.getElementById('timerDisplay').innerText = `${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
            }
            if (timeRemaining <= 0) finishGame();
        }, 1000);

        // MULAI BLOCK PERTAMA (Dengan Override)
        startNextLevelBlock();
    };

    function startNextLevelBlock() {
        // LOGIKA UTAMA BINARY SEARCH
        
        if (minIndex > maxIndex) {
            finishGame();
            return;
        }
        
        // Cek apakah ada override untuk level awal (berdasarkan kelas)
        if (startLevelOverride !== null) {
            currentLevelIndex = startLevelOverride;
            startLevelOverride = null; // Reset agar langkah berikutnya kembali ke binary search
        } else {
            // Binary Search normal
            currentLevelIndex = Math.floor((minIndex + maxIndex) / 2);
        }

        const levelName = LEVEL_ORDER[currentLevelIndex];

        // Ambil 5 soal untuk level ini
        questionsInCurrentLevel = questions.filter(q => q.level === levelName);
        
        // Reset pointer & score level ini
        currentQuestionPointer = 0;
        currentLevelScore = 0;
        currentLevelWrong = 0; // Reset kesalahan
        
        loadQuestion();
    }

    function loadQuestion() {
        feedbackArea.style.display = 'none';
        isAnswering = true;

        // Visual Progress Bar (0% - 100% dalam konteks 5 soal per level)
        const progress = (currentQuestionPointer / questionsInCurrentLevel.length) * 100;
        progressBar.style.width = `${progress}%`;

        const q = questionsInCurrentLevel[currentQuestionPointer];
        
        // Tampilkan Level label kecil di atas soal (EDITED: Removed Level Name)
        questionText.innerHTML = `<div style="font-size:0.8em; color:#e67e22; margin-bottom:10px; text-transform:uppercase;">Soal ${currentQuestionPointer + 1}/5</div>` + q.text;
        
        optionsContainer.innerHTML = '';
        optionsContainer.style.gridTemplateColumns = (window.innerWidth > 600 && q.options.length !== 5) ? "repeat(2, 1fr)" : "1fr";

        q.options.forEach((opt, index) => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerHTML = opt;
            btn.onclick = () => checkAnswer(index, btn);
            optionsContainer.appendChild(btn);
        });

        // Render MathJax
        if(window.renderMathInElement) { 
            renderMathInElement(gameScreen, { delimiters: [
                {left: '$$', right: '$$', display: true}, 
                 {left: '$', right: '$', display: false}, 
                {left: '\\(', right: '\\)', display: false},
                {left: '\\[', right: '\\]', display: true}
            ]});
        }
        
        // Scroll top
        if(window.innerWidth < 768) window.scrollTo({top:0, behavior:'smooth'});
        else document.querySelector('.game-stage').scrollTo({top:0, behavior:'smooth'});
    }

    function checkAnswer(selectedIndex, btnElement) {
        if (!isAnswering) return; 
        isAnswering = false;
        
        const q = questionsInCurrentLevel[currentQuestionPointer];
        document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);

        if (selectedIndex === q.answer) {
            btnElement.classList.add('correct');
            feedbackMessage.innerText = "Benar! üéâ";
            feedbackMessage.style.color = "#27ae60";
            currentLevelScore++;
            totalCorrectAnswers++;
        } else {
            btnElement.classList.add('wrong');
            feedbackMessage.innerText = "Kurang Tepat üòî";
            feedbackMessage.style.color = "#c0392b";
            
            currentLevelWrong++; // Catat kesalahan di level ini

            // Hitung nomor soal asli (index di array questions + 1)
            const questionNumber = questions.indexOf(q) + 1;

            // Catat salah untuk report
            wrongAnswers.push({
                qNum: questionNumber, // ADDED: Simpan nomor soal
                level: q.level,
                text: q.text,
                options: q.options,
                userIndex: selectedIndex,
                correctIndex: q.answer
            });
        }

        feedbackArea.style.display = 'flex';
        
        // Update fungsi tombol lanjut
        nextBtn.onclick = nextQuestionLogic;
    }

    function nextQuestionLogic() {
        currentQuestionPointer++;

        // REQ 1: SISWA HARUS MENGERJAKAN 5 SOAL (Hapus kondisi early exit)
        if (currentQuestionPointer >= questionsInCurrentLevel.length) {
            evaluateLevelBlock();
        } else {
            loadQuestion();
        }
    }

    function evaluateLevelBlock() {
        // Logika Penentuan Nasib:
        // Lulus jika Benar >= 4 dari 5 soal
        const isPassed = currentLevelScore >= 4;
        const currentLevelName = LEVEL_ORDER[currentLevelIndex];

        let titleMsg = "";
        let bodyMsg = "";

        if (isPassed) {
            // LULUS -> Simpan level ini sebagai kandidat terbaik sementara
            bestLevelReached = currentLevelName;
            
            // Geser pencarian ke kanan (Level lebih tinggi)
            minIndex = currentLevelIndex + 1;
            
            titleMsg = "Luar Biasa! üåü";
            // REQ 2: Kalimat Menyenangkan untuk Level Naik
            bodyMsg = `Kamu berhasil menjawab <strong>${currentLevelScore} dari 5</strong> soal dengan benar!<br>Kemampuanmu keren banget. Yuk, kita coba tantangan berikutnya! üöÄ`;
        } else {
            // GAGAL -> Range level terlalu tinggi
            // Geser pencarian ke kiri (Level lebih rendah)
            maxIndex = currentLevelIndex - 1;

            titleMsg = "Tetap Semangat! üí™";
            // REQ 2: Kalimat Menyenangkan untuk Level Turun
            bodyMsg = `Kamu menjawab <strong>${currentLevelScore} dari 5</strong> soal dengan benar.<br>Tidak apa-apa, belajar itu proses! Kita cari soal yang lebih pas buat kamu ya. üòä`;
        }

        // Jika algoritma akan berhenti (karena min > max), ubah pesan
        if (minIndex > maxIndex) {
            titleMsg = "Tes Selesai! üéâ";
            bodyMsg = "Terima kasih sudah berjuang sampai akhir! Kita lihat hasilnya ya...";
        }

        // Tampilkan Modal Checkpoint
        checkpointMsg.innerText = isPassed ? "LEVEL UP ‚¨ÜÔ∏è" : "ADJUSTING ‚¨áÔ∏è";
        checkpointMsg.style.color = isPassed ? "#27ae60" : "#f39c12";
        
        // Jika sudah selesai, sembunyikan indikator adjusting
        if (minIndex > maxIndex) {
            checkpointMsg.style.display = 'none';
        } else {
            checkpointMsg.style.display = 'block';
        }

        document.querySelector('.checkpoint-content h2').innerText = titleMsg;
        document.querySelector('.checkpoint-content p:nth-of-type(2)').innerHTML = bodyMsg; // Use innerHTML for bold tag
        
        document.getElementById('checkpointModal').style.display = 'flex';
    }

    window.closeCheckpoint = function() {
        document.getElementById('checkpointModal').style.display = 'none';
        startNextLevelBlock(); // Lanjut ke blok berikutnya (atau finish)
    };

    function finishGame() {
        clearInterval(timerInterval);
        gameScreen.classList.remove('active');
        resultScreen.classList.add('active');
        statusBar.style.visibility = 'hidden';

        // Sembunyikan Area Feedback
        document.getElementById('feedbackArea').style.display = 'none';

        // Hitung Waktu
        let timeUsedSeconds = 3600 - timeRemaining;
        let m = Math.floor(timeUsedSeconds / 60);
        let s = timeUsedSeconds % 60;
        let timeString = `${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;

        // Fallback logic
        if (bestLevelReached === "Placement Start" && maxIndex < 0) {
            bestLevelReached = "Discovery 1";
        }

        // Tampilkan di UI
        document.getElementById('finalPlacement').innerText = bestLevelReached.toUpperCase();
        document.getElementById('finalScore').innerText = totalCorrectAnswers; 
        document.getElementById('timeUsed').innerText = timeString;

        generateReportCard();

        // --- LOGIKA KIRIM KE GOOGLE SHEETS ---
        sendToGoogleSheet(timeString);
    }

    function sendToGoogleSheet(timeString) {
        // 1. Siapkan data laporan salah agar rapi di excel
        let laporanSalah = "";
        if(wrongAnswers.length > 0) {
            laporanSalah = wrongAnswers.map(w => `[Soal #${w.qNum}|${w.level}] ${w.text.substring(0, 20)}... (Jawab: ${w.options[w.userIndex]})`).join(" | ");
        } else {
            laporanSalah = "Sempurna";
        }

        // 2. Bungkus data jadi objek
        const dataToSend = {
            nama: studentName,
            kelas: studentClass,
            level: bestLevelReached,
            skor: totalCorrectAnswers,
            waktu: timeString,
            laporan: laporanSalah
        };

        // 3. Ubah tombol report sementara jadi indikator loading
        const btnReport = document.getElementById('btnReportToggle');
        const originalText = btnReport.innerText;
        btnReport.innerText = "‚è≥ Menyimpan Nilai...";
        btnReport.disabled = true;

        // REQUEST 2: JANGAN DISAMBUNG KE SHEET DULU (TEST MODE)
        // Kita simulasikan sukses tapi tanpa fetch()
        console.log("Data siap kirim (Test Mode):", dataToSend);

        setTimeout(() => {
            btnReport.innerText = "‚úÖ Tersimpan (Mode Test)! " + originalText;
            btnReport.disabled = false;
            setTimeout(() => {
                btnReport.innerText = originalText;
            }, 3000);
        }, 1000);

        /* --- KODE ASLI DINONAKTIFKAN UNTUK SEMENTARA ---
        fetch(googleScriptURL, {
            method: 'POST',
            mode: 'no-cors',
            cache: 'no-cache',
            headers: { 'Content-Type': 'application/json' },
            redirect: 'follow',
            body: JSON.stringify(dataToSend)
        })
        .then(response => {
            btnReport.innerText = "‚úÖ Tersimpan! " + originalText;
            btnReport.disabled = false;
            setTimeout(() => { btnReport.innerText = originalText; }, 3000);
        })
        .catch(error => {
            console.error('Error:', error);
            btnReport.innerText = "‚ö†Ô∏è Gagal Simpan";
            btnReport.disabled = false;
        });
        */
    }

    function generateReportCard() {
        const list = document.getElementById('reportList');
        list.innerHTML = '';
        
        if (wrongAnswers.length === 0) {
            list.innerHTML = '<li class="report-item" style="text-align:center; color:#27ae60;">Sempurna! Tidak ada kesalahan pada soal yang dikerjakan.</li>';
            return;
        }

        wrongAnswers.forEach((item, idx) => {
            const li = document.createElement('li');
            li.className = 'report-item';
            
            let gridHtml = `<div class="report-grid">`;
            item.options.forEach((opt, optIdx) => {
                let statusClass = '';
                if (optIdx === item.correctIndex) statusClass = 'correct';
                else if (optIdx === item.userIndex) statusClass = 'wrong';
                
                gridHtml += `<div class="option-btn report-variant ${statusClass}">${opt}</div>`;
            });
            gridHtml += `</div>`;

            // ADDED: Tampilkan No. Soal di meta info
            li.innerHTML = `
                <div class="report-meta">No. ${item.qNum} ‚Ä¢ ${item.level}</div>
                <div class="report-q-text">${item.text}</div>
                ${gridHtml}
            `;
            list.appendChild(li);
        });
        
        if(window.renderMathInElement) { 
            renderMathInElement(list);
        }
    }

    window.toggleReport = function() {
        const rc = document.getElementById('reportCard');
        const btn = document.getElementById('btnReportToggle');
        
        if (rc.style.display === 'block') {
            rc.style.display = 'none';
            btn.innerText = 'üìã Lihat Detail Jawaban Salah';
        } else {
            rc.style.display = 'block';
            btn.innerText = 'üîº Tutup Detail';
            setTimeout(() => rc.scrollIntoView({ behavior: 'smooth' }), 100);
        }
    };

    window.clearAndReload = function() {
        location.reload();
    }
</script>
</body>
</html>
