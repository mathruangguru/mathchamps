<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Math Champs Placement Test</title>
    
    <!-- Font 'Nunito' -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- KaTeX untuk Rumus Matematika Cantik -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        :root {
            --primary: #FF9F1C; 
            --primary-dark: #e08b15;
            --secondary: #2EC4B6;
            --secondary-dark: #259f93;
            --accent: #E71D36;
            --dark: #011627;
            --light: #FDFFFC;
            --bg-gradient: linear-gradient(135deg, #E0F7FA 0%, #80DEEA 100%);
            --header-bg: #011627;
            --text-main: #2c3e50;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- GLOBAL LAYOUT --- */
        html {
            height: 100%;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: var(--bg-gradient);
            margin: 0;
            padding: 0;
            color: var(--text-main);
            height: 100%;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            width: 100vw;
            background-image: 
                radial-gradient(#2EC4B6 1px, transparent 1px), 
                radial-gradient(#2EC4B6 1px, transparent 1px);
            background-position: 0 0, 25px 25px;
            background-size: 50px 50px;
            background-color: #f0f8ff;
        }

        /* --- HEADER --- */
        header {
            background: var(--header-bg);
            padding: 15px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 50;
            position: relative;
            flex-shrink: 0; 
            height: 80px;
        }

        .logo {
            height: 40px;
            object-fit: contain;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
            display: block; 
        }

        .status-bar {
            display: flex;
            gap: 15px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.15);
            padding: 10px 20px; 
            border-radius: 50px;
            font-weight: 800;
            color: white;
            font-size: 1.2rem; 
            border: 2px solid rgba(255,255,255,0.2);
            transition: transform 0.2s, background 0.2s;
        }
        
        .status-item span:first-child {
            font-size: 1.4rem;
        }
        
        .status-item.pulse-green {
            animation: pulseGreen 1s ease;
            background: rgba(46, 204, 113, 0.4);
        }

        @keyframes pulseGreen {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* --- DESKTOP LAYOUT (IMMERSIVE) --- */
        @media (min-width: 769px) {
            body {
                overflow: hidden; 
            }
            .app-container {
                height: 100vh;
            }
            .game-stage {
                flex: 1;
                overflow-y: auto; 
                padding: 20px;
                display: flex;
                justify-content: center;
                scrollbar-width: thin;
                scrollbar-color: #ccc transparent;
            }
            .content-card {
                margin: auto 0;
                max-width: 900px;
                background: rgba(255, 255, 255, 0.95);
                border-radius: 24px;
                padding: 40px;
                box-shadow: 0 10px 40px rgba(1, 22, 39, 0.1);
                animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                width: 100%;
            }
            .feedback-container {
                margin-top: 30px;
                position: static;
                display: none; 
                flex-direction: column;
                align-items: center;
                animation: popIn 0.3s ease;
            }
        }

        /* --- MOBILE LAYOUT (SCROLL FIX) --- */
        @media (max-width: 768px) {
            body {
                overflow-y: auto; 
                height: auto;
            }
            html {
                height: auto;
            }
            .app-container {
                height: auto;
                min-height: 100vh;
                background-size: 20px 20px;
            }
            header {
                position: sticky;
                top: 0;
                padding: 12px 20px;
                justify-content: space-between; 
            }
            .game-stage {
                display: block;
                height: auto;
                padding: 0;
                overflow: visible; 
            }
            .content-card {
                background: white;
                max-width: none;
                border-radius: 0;
                box-shadow: none;
                margin: 0;
                min-height: calc(100vh - 80px); 
                padding: 25px 20px 150px 20px; 
            }
            
            h1 { font-size: 1.6rem !important; }
            .question-box { font-size: 1.1rem !important; }
            
            .feedback-container {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: white;
                padding: 20px;
                box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
                animation: slideUp 0.3s ease;
                border-top: 1px solid #eee;
                display: none; 
                flex-direction: column;
                align-items: center;
                z-index: 100;
            }
        }

        /* --- ANIMATIONS & COMMON --- */
        @keyframes popIn {
            from { opacity: 0; transform: scale(0.95) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        h1 {
            color: var(--primary);
            font-weight: 900;
            font-size: 2.2rem;
            margin: 0 0 10px 0;
            text-transform: uppercase;
            letter-spacing: -0.5px;
        }

        h2 {
            color: #7f8c8d;
            font-weight: 600;
            margin: 0;
        }

        .progress-container {
            background: #eef2f5;
            height: 14px;
            border-radius: 50px;
            margin: 0 0 30px; 
            overflow: hidden;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), #ffcb05);
            width: 0%;
            border-radius: 50px;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background-image: linear-gradient(
                45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent
            );
            background-size: 20px 20px;
            animation: moveStripes 1s linear infinite;
        }

        @keyframes moveStripes {
            0% { background-position: 0 0; }
            100% { background-position: 20px 20px; }
        }

        .question-box {
            font-size: 1.35rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 30px;
            line-height: 1.5;
        }

        .q-img {
            max-width: 100%;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin: 20px 0;
            border: 4px solid #fff;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        @media (max-width: 600px) {
            .options-grid { grid-template-columns: 1fr; }
        }

        .option-btn {
            background: white;
            border: 2px solid #e0e6ed;
            border-bottom: 6px solid #e0e6ed;
            padding: 20px;
            border-radius: 20px;
            font-size: 1.1rem;
            color: var(--text-main);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
            font-family: 'Nunito', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .option-btn:hover:not(:disabled) {
            border-color: var(--secondary);
            border-bottom-color: var(--secondary-dark);
            background: #f0fffd;
            transform: translateY(-2px);
        }

        .option-btn:active:not(:disabled) {
            transform: translateY(4px);
            border-bottom-width: 2px;
            margin-top: 4px;
        }

        .option-btn:disabled {
            opacity: 0.8;
            cursor: default;
        }

        .option-btn.correct {
            background: #d1f7c4;
            border-color: #2ecc71;
            border-bottom-color: #27ae60;
            color: #27ae60;
        }

        .option-btn.wrong {
            background: #fadbd8;
            border-color: #e74c3c;
            border-bottom-color: #c0392b;
            color: #c0392b;
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            border-bottom: 5px solid var(--primary-dark);
            padding: 18px 40px;
            font-size: 1.2rem;
            border-radius: 50px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.1s;
            font-family: 'Nunito', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: inline-block;
            margin-top: 20px;
            width: 100%;
        }

        .btn:active {
            transform: translateY(3px);
            border-bottom-width: 2px;
            margin-top: 23px;
        }

        .btn-next {
            background: var(--secondary);
            border-bottom: 5px solid var(--secondary-dark);
        }
        
        .btn-report {
            background: white;
            color: var(--dark);
            border: 2px solid #ddd;
            border-bottom: 5px solid #ccc;
            margin-top: 15px;
        }
        
        .btn-report:active {
            border-bottom-width: 2px;
            margin-top: 18px;
        }

        .feedback-msg {
            font-size: 1.4rem;
            font-weight: 800;
            margin-bottom: 15px;
        }
        
        .life-bonus-notif {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            font-size: 1.5rem;
            font-weight: bold;
            z-index: 200;
            pointer-events: none;
            animation: floatUpFade 2s forwards;
            display: none;
            text-align: center;
        }
        
        @keyframes floatUpFade {
            0% { opacity: 0; transform: translate(-50%, -40%); }
            20% { opacity: 1; transform: translate(-50%, -50%); }
            80% { opacity: 1; transform: translate(-50%, -60%); }
            100% { opacity: 0; transform: translate(-50%, -70%); }
        }

        /* Checkpoint Overlay */
        .checkpoint-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(1, 22, 39, 0.9);
            z-index: 200;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .checkpoint-content {
            background: white;
            padding: 40px;
            border-radius: 30px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            animation: zoomIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }

        .checkpoint-content::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; height: 10px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        @keyframes zoomIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* REPORT CARD STYLES */
        .report-card {
            display: none; /* Hidden by default */
            margin-top: 30px;
            text-align: left;
            background: #fff;
            border-radius: 15px;
            border: 2px solid #eee;
            overflow: hidden;
            animation: slideUp 0.3s ease;
        }
        
        .report-header {
            background: var(--dark);
            color: white;
            padding: 15px 20px;
            font-weight: 800;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .report-list {
            padding: 0;
            margin: 0;
            list-style: none;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .report-item {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            font-size: 0.95rem;
        }
        
        .report-item:last-child {
            border-bottom: none;
        }
        
        .report-meta {
            display: inline-block;
            background: #f0f0f0;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 700;
            color: #666;
            margin-bottom: 8px;
        }
        
        .report-q-text img {
            max-width: 100%;
            height: auto;
            max-height: 100px; /* Smaller images for report */
            display: block;
            margin: 10px 0;
        }

        .screen { display: none; width: 100%; }
        .screen.active { display: block; }

        .result-level {
            font-size: 3.5rem;
            font-weight: 900;
            color: white;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.1);
        }
        
        .result-card-inner {
            background: linear-gradient(135deg, #FF9F1C, #FF5E00);
            padding: 40px;
            border-radius: 30px;
            color: white;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
            box-shadow: 0 15px 30px rgba(255, 159, 28, 0.4);
        }

        .result-card-inner::before {
            content: 'üèÜ';
            position: absolute;
            font-size: 10rem;
            opacity: 0.1;
            right: -20px;
            bottom: -20px;
            transform: rotate(-15deg);
        }

        .opt-img { max-height: 80px; object-fit: contain; pointer-events: none; }
        
        /* HIDE REQUESTED ELEMENTS */
        .game-info-header {
            display: none !important;
        }
    </style>
</head>
<body>

<div class="app-container">
    <!-- HEADER -->
    <header>
        <!-- Logo Displayed -->
        <img src="https://imgix3.ruangguru.com/assets/miscellaneous/png_aaojxe_9962.png" alt="Math Champs" class="logo">
        
        <div class="status-bar" id="statusBar" style="visibility: hidden;">
            <div class="status-item" id="lifeContainer">
                <span>‚ù§Ô∏è</span> <span id="livesDisplay">3</span>
            </div>
            <!-- Timer hidden visually but logic remains -->
            <div class="status-item" style="display: none;">
                <span>‚è±Ô∏è</span> <span id="timerDisplay">60:00</span>
            </div>
        </div>
    </header>

    <!-- MAIN GAME STAGE -->
    <div class="game-stage">
        <div class="content-card">
            
            <!-- SCREEN 1: START -->
            <div id="startScreen" class="screen active" style="text-align: center;">
                <div style="font-size: 4rem; margin-bottom: 10px;">üî•</div>
                <h1>Siapkan Mentalmu!</h1>
                <h2 style="margin-bottom: 30px;">Waktu terus berjalan. Buktikan kehebatanmu sekarang!</h2>

                <div style="background: #FFF8E1; padding: 25px; border-radius: 20px; text-align: left; border: 2px solid #FFE082; margin-bottom: 30px;">
                    <h3 style="margin: 0 0 15px 0; color: #F57F17;">üìú Aturan Main:</h3>
                    <ul style="margin: 0; padding-left: 20px; color: #5d4037; font-size: 1.1rem; line-height: 1.6;">
                        <li>Kamu punya <strong>3 Nyawa</strong> ‚ù§Ô∏è</li>
                        <li>Waktu pengerjaan maksimal <strong>60 Menit</strong> (Internal) ‚è±Ô∏è</li>
                        <li>Jawab benar minimal 4 soal dalam satu level untuk mendapatkan <strong>+1 Nyawa</strong>! üéÅ</li>
                        <li>Tes berhenti jika nyawa habis atau waktu selesai.</li>
                    </ul>
                </div>

                <button class="btn" onclick="startGame()">Mulai Sekarang üöÄ</button>
            </div>

            <!-- SCREEN 2: GAME -->
            <div id="gameScreen" class="screen">
                <!-- Wrapper for level info and qNum, HIDDEN via CSS -->
                <div class="game-info-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div id="currentLevelName" style="background: var(--dark); color: white; padding: 5px 15px; border-radius: 20px; font-weight: 700; font-size: 0.85rem;">LEVEL D1</div>
                    <div id="qNumContainer" style="color: #95a5a6; font-weight: 700; font-size: 0.9rem; margin-left: auto;">Soal <span id="qNum">1</span>/60</div>
                </div>

                <div class="progress-container">
                    <div class="progress-fill" id="progressBar"></div>
                </div>
                
                <div class="question-box" id="questionText">
                    <!-- Soal -->
                </div>

                <div class="options-grid" id="optionsContainer">
                    <!-- Pilihan -->
                </div>
            </div>

            <!-- SCREEN 3: RESULT -->
            <div id="resultScreen" class="screen" style="text-align: center;">
                <h1>Tes Selesai! üéâ</h1>
                <p style="font-size: 1.2rem; color: #7f8c8d;">Kamu direkomendasikan masuk ke:</p>
                
                <div class="result-card-inner">
                    <div style="font-size: 1rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 2px;">Level Kamu</div>
                    <div class="result-level" id="finalPlacement">MASTERY 1</div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 30px;">
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; border: 2px solid #eee;">
                        <div style="font-size: 2rem; font-weight: 900; color: var(--dark);" id="finalScore">0/60</div>
                        <div style="color: #95a5a6; font-size: 0.9rem; font-weight: 700;">SKOR BENAR</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; border: 2px solid #eee;">
                        <div style="font-size: 2rem; font-weight: 900; color: var(--dark);" id="timeUsed">00:00</div>
                        <div style="color: #95a5a6; font-size: 0.9rem; font-weight: 700;">WAKTU</div>
                    </div>
                </div>
                
                <!-- Report Card Toggle Button -->
                <button class="btn btn-report" onclick="toggleReport()" id="btnReportToggle">üìã Lihat Detail Jawaban Salah</button>
                
                <!-- Report Card Container -->
                <div id="reportCard" class="report-card">
                    <div class="report-header">
                        <span>Analisis Kesalahan</span>
                        <span style="font-size: 0.8rem; opacity: 0.8;">Untuk Advisor</span>
                    </div>
                    <ul id="reportList" class="report-list">
                        <!-- List items will be injected here -->
                    </ul>
                </div>
                
                <button class="btn" style="background: var(--dark); border-bottom-color: black; margin-top: 10px;" onclick="clearAndReload()">Coba Lagi ‚Ü∫</button>
            </div>
            
            <!-- FEEDBACK AREA -->
            <div class="feedback-container" id="feedbackArea">
                <div class="feedback-msg" id="feedbackMessage">Jawaban Benar!</div>
                <button class="btn btn-next" id="nextBtn" onclick="nextQuestion()">Lanjut ‚ûî</button>
            </div>
            
            <!-- CHECKPOINT MODAL -->
            <div id="checkpointModal" class="checkpoint-overlay">
                <div class="checkpoint-content">
                    <div style="font-size: 4rem; margin-bottom: 10px;">‚≠ê</div>
                    <h2 style="color: var(--primary); font-size: 1.8rem; margin-bottom: 10px;">CHECKPOINT!</h2>
                    <p style="font-size: 1.1rem; color: #555;">Level Selesai!</p>
                    <p id="checkpointMsg" style="color: #27ae60; font-weight: bold; margin: 15px 0;">+1 Nyawa ‚ù§Ô∏è</p>
                    <p style="font-size: 0.9rem; color: #888; margin-bottom: 25px;">Siap untuk tantangan berikutnya?</p>
                    <button class="btn" onclick="closeCheckpoint()">LANJUT KE LEVEL BERIKUTNYA ‚ñ∂</button>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // --- DATABASE SOAL (SAMA PERSIS) ---
    const questions = [
        // --- D1 ---
        { level: "Discovery 1", text: "Perhatikan gambar di bawah ini.<br><img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_titfbd_7044.png' class='q-img'><br>Pilih jawaban yang sesuai dengan gambar di atas.", options: ["Jumlah bola basket 6 lebih banyak dari jumlah bola voli", "Jumlah bola voli 5 lebih sedikit dari jumlah bola basket", "Jumlah bola basket dan bola voli adalah 14", "Jumlah bola basket lebih sedikit dari jumlah bola voli"], answer: 1 },
        { level: "Discovery 1", text: "15 anak sedang berbaris dalam sebuah antrean untuk membeli es krim. Ada 9 anak di belakang Ron. Ron berada pada posisi ke-berapa dari depan?", options: ["Ke-5", "Ke-6", "Ke-7", "Ke-10"], answer: 1 },
        { level: "Discovery 1", text: "Gambar-gambar di bawah ini menunjukkan ikatan bilangan (number bonds).<br><img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_97z5jc_7611.png' class='q-img'><br>Diberikan ikatan bilangan berantai di bawah ini.<br><img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_ijtcjt_9349.png' class='q-img'><br>Berapakah nilai dari ‚òÜ?", options: ["4", "3", "2", "1"], answer: 2 },
        { level: "Discovery 1", text: "Berikut ini adalah gambar 4 buah penjepit.<br><img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_wd33ao_5162.png' class='q-img'><br>Selisih panjang penjepit terpanjang dengan penjepit terpendek adalah _____ satuan.", options: ["1", "2", "3", "4"], answer: 3 },
        { level: "Discovery 1", text: "Di lapangan, jumlah anak laki-laki 5 lebih sedikit dari jumlah anak perempuan. Setelah 2 anak laki-laki pulang ke rumah, tersisa 3 anak laki-laki di lapangan. Ada berapa anak perempuan yang sedang berada di lapangan?", options: ["5 anak", "8 anak", "10 anak", "12 anak"], answer: 2 },
        
        // --- D2 ---
        { level: "Discovery 2", text: "Pilih gambar atau angka yang menunjukkan jumlah terbanyak.", options: ["<img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_cgtmnk_9396.png' class='opt-img'>", "<img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_aaxioe_4243.png' class='opt-img'>", "<img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_yseo9t_9467.png' class='opt-img'>", "<img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_9o44nk_7986.png' class='opt-img'>"], answer: 3 },
        { level: "Discovery 2", text: "Joan membeli 3 ekor ikan hias.<br>Robin membeli 2 ekor ikan hias lebih banyak dari Joan.<br>Doni membeli 5 ekor ikan hias lebih banyak dari Robin.<br>Berapa banyak jumlah semua ikan hias milik Joan, Robin, dan Doni?", options: ["15 ekor", "18 ekor", "20 ekor", "23 ekor"], answer: 1 },
        { level: "Discovery 2", text: "Beni menggambar jam dinding pada saat ia akan tidur dan pada waktu ia bangun keesokan harinya, seperti ditunjukkan pada gambar di bawah ini.<br><img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_97ulcy_7558.png' class='q-img'><br>Berapa jam Beni tertidur di malam itu?", options: ["7 jam", "7 jam, 30 menit", "8 jam", "8 jam, 30 menit"], answer: 3 },
        { level: "Discovery 2", text: "Pilih satu yang berbeda dari gambar maupun simbol di bawah ini.", options: ["<img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_xorsar_1261.png' class='opt-img'>", "<img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_43wc63_2087.png' class='opt-img'>", "<img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_loeumr_6814.png' class='opt-img'>", "<img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_6w6jdw_1911.png' class='opt-img'>"], answer: 0 },
        { level: "Discovery 2", text: "Grafik berikut menunjukkan jumlah poin yang dikumpulkan 3 orang siswa dalam satu semester.<br><img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_l45ksg_7783.png' class='q-img'><br>Banyak total poin yang didapatkan oleh Evelyn adalah ‚Ä¶.", options: ["10 poin", "15 poin", "20 poin", "25 poin"], answer: 1 },

        // --- D3 ---
        { level: "Discovery 3", text: "Perhatikan dua gambar di bawah ini.<br><img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_cifrej_2996.png' class='q-img'><br>Cari selisih jumlah kubus satuan di kedua gambar di atas.", options: ["4", "25", "136", "140"], answer: 2 },
        { level: "Discovery 3", text: "Rara memiliki 3 balon lebih banyak dari Riri. Jumlah semua balon Rara dan Riri adalah 11 balon. Berapa balon Rara?", options: ["4 balon", "5 balon", "6 balon", "7 balon"], answer: 3 },
        { level: "Discovery 3", text: "Tinggi kakak 1 meter dan 36 centimeter.<br>Tinggi adik 51 centimeter.<br>Berapa selisih tinggi kakak dan adik?", options: ["75 cm", "85 cm", "115 cm", "187 cm"], answer: 1 },
        { level: "Discovery 3", text: "Perhatikan pola berikut: ‚ñ≥‚ñ¢‚óØ‚óØ‚ñ≥‚ñ¢‚óØ‚óØ‚ñ≥‚ñ¢‚óØ‚óØ‚ñ≥‚ñ¢‚Ä¶<br>Gambar apakah yang ada di urutan ke-20 dan ke-30?", options: ["Ke-20: ‚ñ≥, ke-30: ‚ñ¢", "Ke-20: ‚ñ¢, ke-30: ‚óØ", "Ke-20: ‚óØ, ke-30: ‚ñ≥", "Ke-20: ‚óØ, ke-30: ‚ñ¢"], answer: 3 },
        { level: "Discovery 3", text: "Sharon memiliki 25 buah mangga. Sharon membagikan sebanyak-banyaknya mangga tersebut kepada 3 adiknya sama banyak. Pilih jawaban yang tepat mengenai jumlah buah mangga milik Sharon dan adik-adiknya setelah buah mangga tersebut dibagikan.", options: ["Sharon: 1 mangga, masing-masing adiknya: 8 mangga", "Sharon: 2 mangga, masing-masing adiknya: 8 mangga", "Sharon: 4 mangga, masing-masing adiknya: 7 mangga", "Sharon: 1 mangga, masing-masing adiknya: 3 mangga"], answer: 0 },

        // --- D4 ---
        { level: "Discovery 4", text: "Perhatikan gambar di bawah ini. Manakah gambar yang menunjukkan pecahan yang berbeda dari yang lain?", options: ["<img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_g85x8w_2888.png' class='opt-img'>", "<img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_jq4d6g_7512.png' class='opt-img'>", "<img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_68r0y6_8805.png' class='opt-img'>", "<img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_csyqtj_1706.png' class='opt-img'>"], answer: 3 },
        { level: "Discovery 4", text: "Perhatikan sekumpulan bilangan di bawah ini.<br><img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_e8plka_7489.png' class='q-img'><br>Jumlah dari seluruh bilangan di atas adalah ‚Ä¶", options: ["71", "68", "50", "48"], answer: 0 },
        { level: "Discovery 4", text: "Berapa selisih jumlah sisi dengan jumlah titik sudut pada sebuah limas segiempat?<br><img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_uonulg_778.png' class='q-img'>", options: ["4", "3", "1", "0"], answer: 3 },
        { level: "Discovery 4", text: "Tuliskan bilangan yang tepat untuk melengkapi kalimat matematika di bawah ini.<br>16 + 12 - __ + 14 = 35", options: ["5", "6", "7", "8"], answer: 2 },
        { level: "Discovery 4", text: "Hendro memiliki 2 lembar Rp10.000, 3 lembar Rp5.000, 4 lembar Rp2.000, dan 5 lembar Rp1.000. Ada berapa cara untuk membayar topi seharga Rp14.000 tanpa kembalian?", options: ["3 cara", "5 cara", "6 cara", "9 cara"], answer: 3 },

        // --- E1 ---
        { level: "Exploration 1", text: "Diberikan 5 angka berikut ini: 6, 1, 8, 3, 9.<br>Berapakah bilangan genap 4 digit terbesar yang dapat dibentuk dari angka-angka yang diberikan di atas?", options: ["9863", "9836", "9638", "8963"], answer: 1 },
        { level: "Exploration 1", text: "Tuliskan bilangan yang tepat untuk melengkapi kalimat matematika di bawah ini.<br>4 √ó 11 + __ = 54", options: ["8", "9", "10", "12"], answer: 2 },
        { level: "Exploration 1", text: "Panjang sebuah jalan raya adalah 2 km dan 400 m. Ibu walikota berencana untuk menanamkan pohon dari satu ujung jalan ke ujung jalan yang lain. Jika jarak antar pohon adalah 300 meter, ada berapa pohon yang ditanam oleh ibu walikota?", options: ["8 pohon", "9 pohon", "10 pohon", "12 pohon"], answer: 1 },
        { level: "Exploration 1", text: "Tuliskan bilangan yang tepat untuk melengkapi kalimat matematika di bawah ini.<br>2 √ó 36 : __ = 12", options: ["4", "5", "6", "8"], answer: 2 },
        { level: "Exploration 1", text: "Perhatikan diagram batang (tidak lengkap) di bawah ini.<br>Data Penjualan Laptop Toko iGloo<br><img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_i5dh8e_3438.png' class='q-img'><br>Diketahui bahwa: Laptop yang terjual pada bulan Februari dua kali lebih banyak dibandingkan dengan laptop yang terjual pada bulan Januari. Penjualan pada bulan Maret 30 laptop lebih sedikit dari bulan Februari.<br>Berapakah jumlah semua laptop yang terjual pada bulan Januari sampai Maret?", options: ["150", "180", "195", "210"], answer: 2 },

        // --- E2 ---
        { level: "Exploration 2", text: "Jumlah penonton konser adalah 4.582 orang. Panitia konser mencatat jumlah penonton konser tersebut dengan pembulatan ke ratusan terdekat. Tuliskan lambang bilangan yang dicatat oleh panitia konser.", options: ["4.500", "4.600", "4.580", "5.000"], answer: 1 },
        { level: "Exploration 2", text: "Perhatikan gambar di bawah ini.<br><img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_t5ceh3_8785.png' class='q-img'><br>Pilih operasi pecahan yang tidak sesuai dengan gambar di atas.", options: ["$\\frac{3}{6} + \\frac{2}{6} = \\frac{5}{6}$", "$\\frac{1}{3} + \\frac{1}{2} = \\frac{5}{6}$", "$\\frac{1}{2} + \\frac{1}{3} = \\frac{5}{6}$", "$\\frac{1}{6} + \\frac{2}{3} = \\frac{5}{6}$"], answer: 3 },
        { level: "Exploration 2", text: "Perhatikan gambar dua persegi di bawah ini.<br><img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_raqfib_3385.png' class='q-img'><br>Diketahui panjang sisi Persegi B dua kali lebih panjang dari sisi Persegi A.<br>Luas Persegi B adalah ____ satuan luas.", options: ["18", "27", "36", "81"], answer: 2 },
        { level: "Exploration 2", text: "Kelas 3A terdiri dari 27 siswa. Jika $\\frac{2}{3}$ dari seluruh kelas adalah penggemar Shakira, berapa siswa kelas 3A yang bukan penggemar Shakira?", options: ["9 siswa", "12 siswa", "18 siswa", "21 siswa"], answer: 0 },
        { level: "Exploration 2", text: "Perhatikan diagram batang di bawah ini.<br><img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_dsszag_7310.png' class='q-img'><br>Berapa selisih jumlah pengunjung mal pada hari pengunjung paling banyak dengan pada hari pengunjung paling sedikit?", options: ["200 orang", "250 orang", "280 orang", "300 orang"], answer: 2 },

        // --- E3 ---
        { level: "Exploration 3", text: "Aku adalah bilangan kelipatan 4. Aku memiliki 5 faktor. Bilangan apakah aku?", options: ["12", "16", "20", "24"], answer: 1 },
        { level: "Exploration 3", text: "Perhatikan gambar di bawah ini.<br><img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_svpudi_7183.png' class='q-img'><br>Pilih pernyataan yang tidak sesuai dengan gambar di atas.", options: ["3 √ó 6 = 18", "3 √ó (2 + 4) = 18", "3 √ó 2 + 3 √ó 4 = 18", "5 √ó 3 + 1 √ó 3 = 18"], answer: 3 },
        { level: "Exploration 3", text: "Nena membeli kelereng dari dua toko: Toko A dan Toko B. Toko A menjual kelereng dalam satuan kodi (20 buah). Toko B menjual kelereng dalam satuan lusin (12 buah). Nena membeli 3 kodi dari toko A dan 4 lusin dari toko B. Berapa jumlah kelereng yang Nena beli?", options: ["100 butir", "108 butir", "112 butir", "120 butir"], answer: 1 },
        { level: "Exploration 3", text: "Perhatikan proses perkalian vertikal di bawah ini.<br><img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_2txjur_4140.png' class='q-img'><br>Dari pilihan di bawah ini, pilihan mana yang tidak sesuai dengan proses perkalian vertikal di atas?", options: ["<img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_mdfule_3005.png' class='opt-img'>", "<img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_jrztbl_6062.png' class='opt-img'>", "<img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_ach9y8_9754.png' class='opt-img'>", "<img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_5fklrz_9796.png' class='opt-img'>"], answer: 2 },
        { level: "Exploration 3", text: "Perhatikan proses pembagian vertikal di bawah ini.<br><img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_wervuu_821.png' class='q-img'><br>Dari pilihan di bawah ini, pilihan mana yang tidak sesuai dengan proses pembagian vertikal di atas?", options: ["5 ratusan, 5 puluhan, 4 satuan dibagi 4...", "552 : 4 = (500 + 50 + 2) : 4 ...", "<img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_rweh6q_3353.png' class='opt-img' style='max-height: 150px; width: auto; max-width: 100%;'>", "552 : 4 = 276 : 2 = 138"], answer: 3 },

        // --- E4 ---
        { level: "Exploration 4", text: "Pilih jawaban yang tidak tepat.<br>Anne sedang mencari jumlah dari $\\frac{1}{2}$ dan $\\frac{1}{3}$. Langkah pertama yang ia lakukan adalah mencari pecahan senilai dari $\\frac{1}{2}$ dan $\\frac{1}{3}$ dengan penyebut yang sama. Penyebut yang ia pilih adalah 6. Mengapa Anne harus melakukan hal tersebut?", options: ["Penjumlahan dan pengurangan bilangan hanya bisa dikerjakan ketika satuannya sama", "Sama seperti 1 kodi dan 1 lusin tidak bisa langsung dijumlahkan, 1 perdua dan 1 pertiga juga tidak bisa langsung dijumlahkan", "Cara terbaik untuk menyamakan penyebut beberapa pecahan adalah mengalikan penyebut-penyebutnya", "Tujuan Anne menggunakan kelipatan persekutuan terkecil dari kedua penyebut adalah untuk mempermudah penyederhanaan hasil penjumlahan kedua pecahan tersebut"], answer: 2 },
        { level: "Exploration 4", text: "Perhatikan gambar di bawah ini.<br><img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_2nkzfe_9703.png' class='q-img'><br>Pilih bentuk penulisan bilangan yang tidak sesuai dengan gambar di atas.", options: ["$2\\frac{1}{3}$", "$\\frac{7}{3}$", "7 pertiga", "2,33"], answer: 3 },
        { level: "Exploration 4", text: "Juno sedang mengukur massa sebungkus jeruk dengan neraca. Neraca seimbang ketika Juno menempatkan 2 bandul 1 kg, 1 bandul 500 g, dan 3 bandul 100 g. Ada 8 jeruk dalam bungkusan tersebut. Jika massa jeruk dianggap sama, berapa massa 1 jeruk dalam satuan kilogram dibulatkan ke persepuluhan terdekat?", options: ["0,3 kg", "0,4 kg", "0,35 kg", "3,5 kg"], answer: 2 },
        { level: "Exploration 4", text: "Manakah gambar yang menunjukkan segitiga tumpul sembarang?", options: ["<img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_5mibom_8528.png' class='opt-img'>", "<img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_k0xjrx_1973.png' class='opt-img'>", "<img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_ev10zh_307.png' class='opt-img'>", "<img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_6ycrec_7724.png' class='opt-img'>", "<img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_eveu7b_4099.png' class='opt-img'>"], answer: 2 },
        { level: "Exploration 4", text: "Diagram garis di bawah ini menunjukkan suhu udara harian di kota Zula.<br><img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_hjgndc_4521.png' class='q-img'><br>Kenaikan suhu terbesar terjadi dari tanggal ____", options: ["21 ke 22 Maret", "22 Maret ke 23 Maret", "23 Maret ke 24 Maret", "24 Maret ke 25 Maret", "25 Maret ke 26 Maret"], answer: 2 },

        // --- M1 ---
        { level: "Mastery 1", text: "Cari hasil operasi bilangan di bawah ini.<br>88 √ó 125 - 18 √ó 50 - 24 √ó 25 - 2 √ó 100 = ____", options: ["9.100", "9.200", "9.300", "9.400"], answer: 3 },
        { level: "Mastery 1", text: "Lina mempunyai $3\\frac{1}{4}$ meter pita merah di rumahnya. Dia membeli tambahan $2\\frac{2}{3}$ meter lagi untuk mendekorasi kelasnya. Pita merah yang terpakai untuk mendekorasi kelas adalah $4\\frac{5}{6}$ meter. Berapa meter sisa pita merah yang ia miliki?", options: ["1 meter", "$1\\frac{3}{12}$ meter", "$2\\frac{1}{12}$ meter", "3 meter"], answer: 2 },
        { level: "Mastery 1", text: "Perhatikan dua kubus di bawah ini.<br><img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_xuqp8t_5152.png' class='q-img'><br>Diketahui panjang sisi kubus B 3 kali lebih panjang dari panjang sisi kubus A. Jika volume kubus A adalah 5 cm3, volume kubus B adalah _____ cm3.", options: ["15 cm¬≥", "45 cm¬≥", "135 cm¬≥", "375 cm¬≥"], answer: 1 },
        { level: "Mastery 1", text: "Ibu membuat sejumlah kue. $\\frac{1}{2}$ dari seluruh kue diberikan kepada nenek. $\\frac{2}{3}$ dari sisanya diberikan kepada bibi. Jika jumlah kue yang tersisa adalah 5, berapakah jumlah kue yang ibu buat?", options: ["20 kue", "25 kue", "30 kue", "35 kue"], answer: 2 },
        { level: "Mastery 1", text: "Cari kecepatan yang berbeda dari yang lain.", options: ["60 km/jam", "1 km/menit", "$16\\frac{2}{3}$ m/detik", "1000 km/menit"], answer: 2 },

        // --- M2 ---
        { level: "Mastery 2", text: "20 ‚Äì 12 : 4 + 3 √ó 2 = ___", options: ["10", "16", "23", "25"], answer: 3 },
        { level: "Mastery 2", text: "Ali membelanjakan uangnya 5 kali lebih banyak daripada Baba di sebuah toko. Ali membayar dengan selembar uang 20 ribuan dan menerima kembalian 2 ribu rupiah. Berapa banyak yang dibelanjakan Baba?", options: ["Rp 3.000", "Rp 3.600", "Rp 4.000", "Rp 4.500"], answer: 2 },
        { level: "Mastery 2", text: "Pilih gambar dengan luas yang berbeda.", options: ["<img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_jkmelp_2114.png' class='opt-img'>", "<img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_lwf87h_7322.png' class='opt-img'>", "<img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_estzst_8973.png' class='opt-img'>", "<img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_y6laon_6590.png' class='opt-img'>"], answer: 1 },
        { level: "Mastery 2", text: "Sebuah bak mandi berbentuk balok akan terisi penuh dengan 450 liter air. Jika panjang bak mandi adalah 1 m dan lebar bak mandi 60 cm, berapakah tinggi bak mandi tersebut?", options: ["50 cm", "60 cm", "75 cm", "80 cm"], answer: 2 },
        { level: "Mastery 2", text: "Tabel di bawah ini menunjukkan nilai ujian akhir matematika dari 5 orang siswa.<br><br>Albi: 81, Dian: 98, Helmi: 92, Renata: 72, Yesi: 86.<br><br>Ada berapa anak yang nilainya di atas rata-rata dari kelima siswa tersebut?", options: ["2 orang", "3 orang", "4 orang", "5 orang"], answer: 2 },

        // --- M3 ---
        { level: "Mastery 3", text: "Diketahui: A : B = 5 : 6, B : C = 4 : 5, C ‚Äì A = 3. Cari nilai B + C.", options: ["4", "5", "6", "7"], answer: 1 },
        { level: "Mastery 3", text: "$\\frac{1}{3}$ uang Andi sama dengan $\\frac{2}{5}$ uang Budi. Jika selisih uang mereka Rp5.000, berapa total uang keduanya?", options: ["Rp5.000", "Rp25.000", "Rp30.000", "Rp55.000"], answer: 2 },
        { level: "Mastery 3", text: "Sebuah segitiga sama kaki memiliki dua sudut yang sama besar dan satu sudut lain yang berbeda. Sudut yang berbeda itu merupakan sudut terbesar segitiga dan besarnya 70¬∞. Berapakah hasil penjumlahan kedua sudut yang lain?", options: ["100¬∞", "110¬∞", "120¬∞", "140¬∞"], answer: 3 },
        { level: "Mastery 3", text: "Harga mainan kesukaan kakak naik 20% dibandingkan dengan harga sebelumnya. Jika harga sekarang adalah Rp72.000, berapa harga mainan tersebut sebelum mengalami kenaikan?", options: ["Rp 57.600", "Rp 60.000", "Rp 64.000", "Rp 65.000"], answer: 1 },
        { level: "Mastery 3", text: "Rata-rata dari 4 bilangan adalah 9. Jika salah satu bilangan dibuang, rata-ratanya menjadi 8. Berapakah bilangan yang dibuang tersebut?", options: ["8", "10", "12", "14"], answer: 1 },

        // --- M4 ---
        { level: "Mastery 4", text: "Perhatikan gambar di bawah ini.<br><img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_tmpt91_8057.png' class='q-img'><br>Tentukan operasi pecahan yang sedang diilustrasikan oleh gambar di atas.", options: ["$\\frac{2}{3} + \\frac{1}{3} = 1$", "$\\frac{8}{15} + \\frac{7}{15} = 1$", "$\\frac{4}{5} + \\frac{2}{3} = \\frac{8}{15}$", "$\\frac{2}{4} + \\frac{1}{5} = \\frac{8}{15}$"], answer: 2 },
        { level: "Mastery 4", text: "Merisa menggunakan $\\frac{3}{4}$ uangnya untuk membeli sebuah buku. Kemudian, ia menggunakan $\\frac{1}{2}$ dari sisanya untuk membeli sebuah kalkulator. Jika harga buku Rp30.000 lebih mahal dari harga kalkulator, berapakah harga buku tersebut?", options: ["Rp30.000", "Rp45.000", "Rp60.000", "Rp75.000"], answer: 2 },
        { level: "Mastery 4", text: "Perhatikan gambar di bawah ini.<br><img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_ajuzjn_4657.png' class='q-img'><br>Gambar di atas terbentuk dari sebuah persegi dengan panjang sisi 10 cm dan seperempat lingkaran. Berapakah luas daerah yang diarsir? Gunakan pendekatan œÄ ‚âà 3,14.", options: ["21,5 cm¬≤", "22 cm¬≤", "22,5 cm¬≤", "23 cm¬≤"], answer: 1 },
        { level: "Mastery 4", text: "Pada pk. 07.00, seorang anak bersepeda dari rumah ke perpustakaan dengan kecepatan 18 km/jam. Setelah 20 menit berselang, ibunya menyusul dengan sepeda listrik dengan kecepatan 24 km/jam. Jika jalan dari rumah ke perpustakaan lurus dan kecepatan mereka konstan, pada pukul berapa ibu tersebut akan menyusul anaknya?", options: ["08.00", "08.10", "08.20", "08.30"], answer: 0 },
        { level: "Mastery 4", text: "Pada suatu kelas olahraga, diketahui 24% peserta mengikuti permainan voli. Sudut pembentuk juring bertuliskan SEPAKBOLA pada diagram lingkaran adalah 144¬∞. Jika jumlah seluruh peserta kelas olahraga adalah 50 orang, berapa peserta yang mengikuti permainan basket?<br><img src='https://imgix3.ruangguru.com/assets/miscellaneous/png_mlbbcb_4279.png' class='q-img'>", options: ["12 orang", "15 orang", "18 orang", "20 orang"], answer: 2 }
    ];

    let currentQuestionIndex = 0;
    let lives = 3;
    let timerInterval;
    let timeRemaining = 3600; // 60 minutes default
    let correctAnswers = 0;
    let isAnswering = true;
    let currentLevelCorrect = 0; 
    let wrongAnswers = []; // Store incorrect answers
    
    const STORAGE_KEY = 'math_champs_progress';

    // DOM Elements
    const startScreen = document.getElementById('startScreen');
    const gameScreen = document.getElementById('gameScreen');
    const resultScreen = document.getElementById('resultScreen');
    const questionText = document.getElementById('questionText');
    const optionsContainer = document.getElementById('optionsContainer');
    const progressBar = document.getElementById('progressBar');
    const livesDisplay = document.getElementById('livesDisplay');
    const lifeContainer = document.getElementById('lifeContainer');
    const statusBar = document.getElementById('statusBar');
    const feedbackArea = document.getElementById('feedbackArea');
    const feedbackMessage = document.getElementById('feedbackMessage');
    const nextBtn = document.getElementById('nextBtn');
    const qNum = document.getElementById('qNum');
    const timerDisplay = document.getElementById('timerDisplay');
    const reportCard = document.getElementById('reportCard');
    const reportList = document.getElementById('reportList');
    const btnReportToggle = document.getElementById('btnReportToggle');
    
    // Checkpoint Elements
    const checkpointModal = document.getElementById('checkpointModal');
    const checkpointMsg = document.getElementById('checkpointMsg');

    window.onload = function() {
        loadState();
    };

    function saveState() {
        const state = {
            currentQuestionIndex,
            lives,
            timeRemaining,
            correctAnswers,
            currentLevelCorrect,
            wrongAnswers,
            active: gameScreen.classList.contains('active')
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function loadState() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            const state = JSON.parse(saved);
            if (state.active && state.lives > 0 && state.timeRemaining > 0) {
                currentQuestionIndex = state.currentQuestionIndex;
                lives = state.lives;
                timeRemaining = state.timeRemaining;
                correctAnswers = state.correctAnswers;
                currentLevelCorrect = state.currentLevelCorrect;
                wrongAnswers = state.wrongAnswers || [];
                
                startScreen.classList.remove('active');
                gameScreen.classList.add('active');
                statusBar.style.visibility = 'visible';
                
                updateStats();
                loadQuestion();
                startTimer();
            }
        }
    }

    function clearState() {
        localStorage.removeItem(STORAGE_KEY);
    }

    function startGame() {
        startScreen.classList.remove('active');
        gameScreen.classList.add('active');
        statusBar.style.visibility = 'visible';
        
        currentQuestionIndex = 0;
        lives = 3;
        correctAnswers = 0;
        currentLevelCorrect = 0;
        timeRemaining = 3600;
        wrongAnswers = [];
        
        feedbackArea.style.display = 'none';

        updateStats();
        startTimer();
        loadQuestion();
        saveState(); 
    }
    
    function startTimer() {
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(updateTimerLogic, 1000);
    }

    function updateTimerLogic() {
        timeRemaining--;
        saveState();
        if (timeRemaining <= 0) {
            endGame(false, true);
        }
    }

    function updateStats() {
        livesDisplay.innerText = lives;
        const progress = ((currentQuestionIndex) / questions.length) * 100;
        progressBar.style.width = `${progress}%`;
        if(qNum) qNum.innerText = currentQuestionIndex + 1;
    }

    function loadQuestion() {
        feedbackArea.style.display = 'none';
        isAnswering = true;
        
        if (window.innerWidth < 768) {
             window.scrollTo({ top: 0, behavior: 'smooth' });
        } else {
            document.querySelector('.game-stage').scrollTo({ top: 0, behavior: 'smooth' });
        }

        if (currentQuestionIndex >= questions.length) {
            endGame(true);
            return;
        }

        const q = questions[currentQuestionIndex];
        questionText.innerHTML = `${q.text}`;
        
        optionsContainer.innerHTML = '';
        
        if (q.options.length === 5) {
            optionsContainer.style.gridTemplateColumns = "1fr";
        } else {
             if(window.innerWidth > 600) {
                 optionsContainer.style.gridTemplateColumns = "repeat(2, 1fr)";
             } else {
                 optionsContainer.style.gridTemplateColumns = "1fr";
             }
        }

        q.options.forEach((opt, index) => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            if (opt.includes('$')) {
                btn.innerHTML = opt;
            } else {
                btn.innerHTML = opt;
            }
            btn.onclick = () => checkAnswer(index, btn);
            optionsContainer.appendChild(btn);
        });

        renderMathInElement(document.getElementById('gameScreen'), {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError : false
        });

        updateStats();
    }

    function checkAnswer(selectedIndex, btnElement) {
        if (!isAnswering) return; 
        isAnswering = false;

        const q = questions[currentQuestionIndex];
        const allButtons = document.querySelectorAll('.option-btn');
        allButtons.forEach(b => b.disabled = true);

        if (selectedIndex === q.answer) {
            btnElement.classList.add('correct');
            feedbackMessage.innerText = "Yey! Benar! üéâ";
            feedbackMessage.style.color = "#27ae60";
            correctAnswers++;
            currentLevelCorrect++; 
            
            nextBtn.innerText = "Lanjut";
            nextBtn.className = "btn btn-next";
            nextBtn.style.display = "block"; 
            nextBtn.onclick = handleLevelTransition; 
        } else {
            btnElement.classList.add('wrong');
            lives--;
            updateStats();
            
            // Record Wrong Answer
            wrongAnswers.push({
                index: currentQuestionIndex + 1,
                level: q.level,
                text: q.text
            });
            
            if (lives <= 0) {
                feedbackMessage.innerText = "Yah, Nyawa Habis üíî";
                feedbackMessage.style.color = "#c0392b";
                
                nextBtn.style.display = "none";
                setTimeout(() => endGame(false), 2000);
            } else {
                feedbackMessage.innerText = "Ups, Masih Salah üòî";
                feedbackMessage.style.color = "#c0392b";
                nextBtn.innerText = "Lanjut";
                nextBtn.className = "btn btn-next";
                nextBtn.style.display = "block"; 
                nextBtn.onclick = handleLevelTransition; 
            }
        }
        
        saveState();
        feedbackArea.style.display = 'flex';
    }

    function handleLevelTransition() {
        if ((currentQuestionIndex + 1) % 5 === 0 && (currentQuestionIndex + 1) < questions.length) {
            let bonusText = "";
            let gotBonus = false;

            if (currentLevelCorrect >= 4) {
                if (lives < 3) {
                    lives++;
                    gotBonus = true;
                    bonusText = "+1 Nyawa ‚ù§Ô∏è";
                } else {
                    bonusText = "Nyawa Penuh! ‚ù§Ô∏è";
                }
            } else {
                bonusText = "Tetap Semangat! üí™";
            }
            
            checkpointMsg.innerText = bonusText;
            if(gotBonus) {
                checkpointMsg.style.color = "#27ae60";
                lifeContainer.classList.add('pulse-green');
            } else {
                checkpointMsg.style.color = "#f39c12";
            }

            checkpointModal.style.display = 'flex'; 
            updateStats(); 
            currentLevelCorrect = 0;
            
        } else {
            nextQuestion();
        }
    }

    function closeCheckpoint() {
        checkpointModal.style.display = 'none';
        lifeContainer.classList.remove('pulse-green');
        nextQuestion();
    }

    function nextQuestion() {
        currentQuestionIndex++;
        saveState();
        loadQuestion();
    }

    function endGame(completed = false, timeout = false) {
        clearInterval(timerInterval);
        clearState();
        
        feedbackArea.style.display = 'none';
        
        gameScreen.classList.remove('active');
        resultScreen.classList.add('active');
        statusBar.style.visibility = 'hidden';

        let finalLevel = "";
        
        if (completed) {
            finalLevel = "MASTERY 4 (GRADUATED)";
        } else {
            let idx = Math.min(currentQuestionIndex, questions.length - 1);
            finalLevel = questions[idx].level;
        }

        document.getElementById('finalPlacement').innerText = finalLevel.toUpperCase();
        document.getElementById('finalScore').innerText = `${correctAnswers}/${questions.length}`;
        
        let timeUsedSeconds = 3600 - timeRemaining;
        if (timeout) timeUsedSeconds = 3600;
        
        let m = Math.floor(timeUsedSeconds / 60);
        let s = timeUsedSeconds % 60;
        m = m < 10 ? "0" + m : m;
        s = s < 10 ? "0" + s : s;
        
        document.getElementById('timeUsed').innerText = `${m}:${s}`;
        
        // Generate Report Card
        generateReportCard();
    }
    
    function generateReportCard() {
        reportList.innerHTML = '';
        if (wrongAnswers.length === 0) {
            reportList.innerHTML = '<li class="report-item" style="text-align:center; color:#27ae60;">Luar biasa! Tidak ada kesalahan. üéâ</li>';
            return;
        }
        
        wrongAnswers.forEach(item => {
            const li = document.createElement('li');
            li.className = 'report-item';
            // Clean up text for preview (remove huge br tags if needed, or keep them)
            // Just ensure images scale
            li.innerHTML = `
                <div class="report-meta">Soal ${item.index} ‚Ä¢ ${item.level}</div>
                <div class="report-q-text">${item.text}</div>
            `;
            reportList.appendChild(li);
        });
        
        // Re-render math in report card
        renderMathInElement(reportList, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError : false
        });
    }
    
    function toggleReport() {
        if (reportCard.style.display === 'block') {
            reportCard.style.display = 'none';
            btnReportToggle.innerText = 'üìã Lihat Detail Jawaban Salah';
        } else {
            reportCard.style.display = 'block';
            btnReportToggle.innerText = 'üîº Tutup Detail';
            // Scroll to report
            setTimeout(() => {
                reportCard.scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }
    }
    
    function clearAndReload() {
        clearState();
        location.reload();
    }
</script>
</body>
</html>
